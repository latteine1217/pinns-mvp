# PINNs 逆重建專案物理正確性審查報告

**審查時間**: 2025-09-30  
**審查範圍**: N-S 方程式模組 (`pinnx/physics/ns_2d.py`) 及相關物理模組  
**審查員**: Physicist Sub-Agent  

## 主要發現摘要

✅ **Physics Gate 狀態**: **有條件通過** - 核心物理正確，但需修復API不一致  
⚠️ **主要問題**: 缺失 `NSEquations2D` 類別，API與測試期待不符  
🔧 **修復優先級**: 高優先級 - 阻斷測試通過

---

## 背景

本審查針對 PINNs 逆重建專案中的 N-S 方程式實作進行物理正確性評估。該專案旨在從少量觀測點 (K≤12) 重建湍流場，要求高度的物理一致性與數值穩定性。

### 審查依據
- 2D 不可壓縮 Navier-Stokes 方程式理論
- 變分形式與自動微分實作標準
- VS-PINN 尺度化理論 (Variable Scaling PINN, arXiv:2406.06287)
- 守恆律檢驗標準

---

## 方法/依據

### 物理理論依據
審查基於以下控制方程組：

```
∂u/∂t + u∂u/∂x + v∂u/∂y = -∂p/∂x + ν∇²u + S_x  (x-動量)
∂v/∂t + u∂v/∂x + v∂v/∂y = -∂p/∂y + ν∇²v + S_y  (y-動量)
∂u/∂x + ∂v/∂y = 0                                    (連續方程)
```

### 審查標準
1. **量綱一致性**: 每項量綱必須匹配
2. **守恆律**: 質量、動量、能量守恆
3. **邊界條件**: 物理合理性
4. **數值穩定性**: 梯度計算的魯棒性

---

## 關鍵結論

### ✅ 物理正確性評估

#### 1. N-S 方程式實作 (`ns_residual_2d`)
**結論**: **物理正確** ✅

**詳細分析**:
- ✅ **方程式結構正確**: 動量方程 + 連續方程完整實作
- ✅ **對流項計算**: `u·∇u` 非線性項正確 (L149-150)
- ✅ **黏性項**: 拉普拉斯算子 `ν∇²u` 實作正確 (L137-138)
- ✅ **壓力梯度**: `∂p/∂x`, `∂p/∂y` 正確分離 (L134)
- ✅ **連續方程**: `∇·u = 0` 不可壓縮條件正確 (L169)

#### 2. 量綱分析
**結論**: **量綱一致** ✅

| 項目 | 期望量綱 | 實作量綱 | 狀態 |
|------|----------|----------|------|
| 速度 u,v | [L T⁻¹] | [L T⁻¹] | ✅ |
| 壓力 p | [M L⁻¹ T⁻²] | [M L⁻¹ T⁻²] | ✅ |
| 黏性係數 ν | [L² T⁻¹] | [L² T⁻¹] | ✅ |
| 對流項 u∂u/∂x | [L T⁻²] | [L T⁻²] | ✅ |
| 黏性項 ν∇²u | [L T⁻²] | [L T⁻²] | ✅ |

#### 3. 自動微分實作 (`compute_derivatives`)
**結論**: **數值方法正確** ✅

- ✅ **一階導數**: 使用 `autograd.grad` 正確 (L39-47)
- ✅ **二階導數**: 逐分量計算避免混合項 (L54-66)  
- ✅ **梯度保留**: `create_graph=True` 確保高階導數可用
- ✅ **拉普拉斯算子**: 對角項求和 `∇² = ∂²/∂x² + ∂²/∂y²` (L86)

#### 4. 守恆律檢查 (`check_conservation_laws`)
**結論**: **方法論正確** ✅

- ✅ **質量守恆**: 連續方程殘差監控 (L283-285)
- ✅ **動量守恆**: x,y 動量方程殘差 (L287-290)
- ✅ **能量指標**: 動能梯度作為能量守恆代理 (L294-297)

#### 5. VS-PINN 尺度化 (`scaling.py`)
**結論**: **理論實作正確** ✅

- ✅ **變數分離尺度化**: 輸入/輸出獨立尺度 (L252-266)
- ✅ **可學習參數**: 尺度因子可優化 (L192-212)
- ✅ **梯度反尺度化**: 物理空間梯度校正 (L329-369)
- ✅ **避免除零**: 數值穩定性保護 (L66, L230)

### ⚠️ 識別問題

#### 1. **高優先級問題** - API不一致
**問題**: 缺失 `NSEquations2D` 類別
- **位置**: `demo_basic.py:49` 期待但未定義
- **影響**: 阻斷測試通過，API不一致
- **物理影響**: 無直接物理錯誤，純粹API問題

#### 2. **中優先級問題** - 邊界條件不完整
**問題**: Neumann 和週期邊界條件未實作
- **位置**: `apply_boundary_conditions` L332-340
- **影響**: 限制應用場景
- **物理影響**: 對於通道流等需要壁面條件的問題會有限制

#### 3. **低優先級問題** - 源項處理
**問題**: 源項預設假設 y 方向為零
- **位置**: L159 `S_y = torch.zeros_like(S)`
- **影響**: 限制了一般性
- **物理影響**: 對非單向源項場景可能不適用

---

## 風險

### 🚨 高風險
1. **API 不一致風險**
   - **風險**: 測試無法通過，阻斷開發流程
   - **影響範圍**: 全專案
   - **緩解**: 立即實作 `NSEquations2D` 包裝類別

### ⚠️ 中風險  
2. **邊界條件限制風險**
   - **風險**: 無法處理複雜邊界條件
   - **影響**: 限制物理問題類型
   - **緩解**: 後續版本補全 Neumann/週期邊界條件

3. **尺度化數值穩定性風險**
   - **風險**: 極端尺度比可能導致梯度消失/爆炸
   - **影響**: 訓練不穩定
   - **緩解**: 添加尺度監控與自動調整

### 🟡 低風險
4. **源項一般性風險**
   - **風險**: 限制源項空間分佈形式
   - **影響**: 某些湍流模型可能不適用
   - **緩解**: 可通過外部 `source_term` 參數解決

---

## 可驗證指標

### 數值驗證指標
1. **方程式殘差收斂性**
   ```python
   |momentum_x| + |momentum_y| + |continuity| < 1e-6
   ```

2. **守恆律滿足度**
   ```python
   mass_conservation_error < 1e-5
   momentum_conservation_error < 1e-4  
   ```

3. **量綱一致性**
   ```python
   assert torch.allclose(scaled_output.std(), torch.ones_like(scaled_output.std()), atol=0.1)
   ```

### 物理驗證指標
1. **解析解比對** (泊肃葉流、庫埃特流)
2. **能量耗散率**: `ε = ν⟨(∂ui/∂xj)²⟩ > 0`
3. **壓力泊松相容性**: `∇²p = -∇·(u·∇u)`

---

## 下一步

### 立即行動 (本任務)
1. **實作 NSEquations2D 類別**
   - 包裝現有函數為面向對象API
   - 與 `demo_basic.py` 期待的介面一致
   - 確保測試通過

### 後續改善 (task-002+)
2. **完善邊界條件模組**
   - 實作 Neumann 邊界條件  
   - 實作週期邊界條件
   - 添加混合邊界條件支援

3. **增強源項處理**
   - 支援向量源項
   - 添加空間依賴源項
   - 實作湍流閉合源項

4. **建立物理驗證測試集**
   - 解析解測試案例
   - 基準問題 (backward-facing step, channel flow)
   - 不確定性量化驗證

---

## 參考

1. **理論基礎**:
   - Raissi et al. "Physics-informed neural networks: A deep learning framework for solving forward and inverse problems involving nonlinear partial differential equations." *JCP* 2019.
   - Liu et al. "Variable Scaling Physics-Informed Neural Networks" arXiv:2406.06287

2. **數值方法**:
   - Baydin et al. "Automatic differentiation in machine learning: a survey." *JMLR* 2018.

3. **湍流理論**:
   - Pope, S.B. "Turbulent Flows." Cambridge University Press, 2000.

---

**最終評估**: 
- ✅ **核心物理**: 正確無誤
- ⚠️ **API 一致性**: 需要修復  
- 🎯 **建議**: 通過 Physics Gate，但需完成 API 修復作為前置條件