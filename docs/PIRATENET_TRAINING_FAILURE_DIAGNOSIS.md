# PirateNet è¨“ç·´å¤±æ•—è¨ºæ–·èˆ‡ä¿®å¾©æŒ‡å—

## ğŸ“‹ å•é¡Œæ‘˜è¦

**ç—‡ç‹€**ï¼š
- è¨“ç·´æå¤±ï¼š`nan`
- é€Ÿåº¦å ´é æ¸¬èª¤å·®ï¼š~100%
- å£“åŠ›å ´é æ¸¬èª¤å·®ï¼š~60%
- æ¨¡å‹è¼¸å‡ºå¹¾ä¹ç‚ºå¸¸æ•¸ï¼ˆé æ¸¬å‡å€¼åé›¢çœŸå¯¦å€¼ 100 å€ï¼‰

**è©•ä¼°æ—¥æœŸ**ï¼š2025-10-16  
**é…ç½®æª”æ¡ˆ**ï¼š`configs/colab_piratenet_2d_slice.yml`  
**è¨“ç·´è¼ªæ•¸**ï¼š1000 epochs  
**è¨­å‚™ç’°å¢ƒ**ï¼šGoogle Colab (CUDA)

---

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### 1. **è¨“ç·´æå¤±ç‚º NaN**ï¼ˆæ•¸å€¼å´©æ½°ï¼‰

#### å¯èƒ½åŸå› ï¼š
| åŸå›  | æ©Ÿç‡ | è­‰æ“š |
|------|------|------|
| **å­¸ç¿’ç‡éé«˜** | â­â­â­â­â­ | é…ç½®ç‚º `1e-3`ï¼Œå° PINNs éæ–¼æ¿€é€² |
| **æ¢¯åº¦çˆ†ç‚¸** | â­â­â­â­â­ | æ¢¯åº¦è£å‰ªå€¼ `1.0` å¯èƒ½ä¸å¤ ä¿å®ˆ |
| **è³‡æ–™æœªæ­¸ä¸€åŒ–** | â­â­â­â­ | é…ç½®æœªæ˜ç¢ºå•Ÿç”¨æ­¸ä¸€åŒ– |
| **Batch size éå¤§** | â­â­â­ | `2048` å¯èƒ½å°è‡´æ¢¯åº¦ä¼°è¨ˆä¸ç©©å®š |
| **Fourier Ïƒ éå¤§** | â­â­â­ | `Ïƒ=2.0` å¯èƒ½å¼•å…¥éå¤§çš„é«˜é »æ“¾å‹• |

#### è¨ºæ–·æ–¹æ³•ï¼š
```bash
# æª¢æŸ¥è¨“ç·´æ—¥èªŒä¸­çš„æ¢¯åº¦ç¯„æ•¸
grep "gradient_norm" log/colab_piratenet_2d_slice/training.log | head -20

# é æœŸï¼šè‹¥ gradient_norm > 100 å‰‡ç‚ºæ¢¯åº¦çˆ†ç‚¸
```

---

### 2. **æ¨¡å‹é æ¸¬å®Œå…¨å¤±æ•ˆ**ï¼ˆæ¬Šé‡å´©æ½°ï¼‰

#### ç—‡ç‹€ç´°ç¯€ï¼š
```
é æ¸¬çµ±è¨ˆé‡ vs çœŸå¯¦çµ±è¨ˆé‡ï¼š
  u: 0.145 vs 9.92  (åé›¢ 98.5%)
  v: 0.028 vs -0.0001 (åé›¢ 28000%)
  w: 0.003 vs -0.002 (åé›¢ 250%)
```

#### å¯èƒ½åŸå› ï¼š
| åŸå›  | æ©Ÿç‡ | è­‰æ“š |
|------|------|------|
| **æ¬Šé‡åˆå§‹åŒ–å•é¡Œ** | â­â­â­â­ | swish + RWF çµ„åˆå¯èƒ½ä¸ç©©å®š |
| **è¼¸å‡ºå±¤æœªæ­£ç¢ºåæ­¸ä¸€åŒ–** | â­â­â­â­ | é æ¸¬ç¯„åœ [0.003, 0.145] æ˜é¡¯åå° |
| **ç‰©ç†æå¤±æ¬Šé‡éä½** | â­â­â­ | `pde_loss_weight: 1.0` vs `data_loss_weight: 50.0` |
| **å£é¢é‚Šç•Œæ¢ä»¶æœªç”Ÿæ•ˆ** | â­â­ | `wall_loss` å¯èƒ½ç‚º 0 æˆ–æœªæ­£ç¢ºè¨ˆç®— |

#### è¨ºæ–·æ–¹æ³•ï¼š
```python
# ä½¿ç”¨è¨ºæ–·è…³æœ¬æª¢æŸ¥æ¨¡å‹æ¬Šé‡
python scripts/debug/diagnose_piratenet_failure.py \
  --checkpoint <checkpoint_path> \
  --config configs/colab_piratenet_2d_slice.yml \
  --output-dir results/diagnosis

# é—œéµæª¢æŸ¥é»ï¼š
# 1. æ¬Šé‡å‡å€¼æ‡‰æ¥è¿‘ 0
# 2. æ¬Šé‡æ¨™æº–å·®æ‡‰åœ¨ [0.01, 0.5] ç¯„åœ
# 3. ä¸æ‡‰åŒ…å« NaN/Inf
```

---

### 3. **é…ç½®å•é¡Œæ¸…å–®**

| å•é¡Œ | åŸå§‹å€¼ | å»ºè­°å€¼ | å„ªå…ˆç´š |
|------|--------|--------|--------|
| å­¸ç¿’ç‡éé«˜ | `1e-3` | `1e-4` | ğŸ”´ é«˜ |
| æ¢¯åº¦è£å‰ªä¸è¶³ | `1.0` | `0.5` | ğŸ”´ é«˜ |
| Batch size éå¤§ | `2048` | `1024` | ğŸŸ¡ ä¸­ |
| Fourier Ïƒ éå¤§ | `2.0` | `1.0` | ğŸŸ¡ ä¸­ |
| è³‡æ–™æœªæ­¸ä¸€åŒ– | æœªæ˜ç¢ºå•Ÿç”¨ | æ˜ç¢ºå•Ÿç”¨ z-score | ğŸ”´ é«˜ |
| æ¿€æ´»å‡½æ•¸é¢¨éšª | `swish` | `tanh` (æ›´ç©©å®š) | ğŸŸ¡ ä¸­ |
| Warmup epochs ä¸è¶³ | `20` | `50` | ğŸŸ¢ ä½ |
| è‡ªé©æ‡‰æ¬Šé‡éæ—©å•Ÿç”¨ | å·²å•Ÿç”¨ | åˆæœŸé—œé–‰ | ğŸŸ¡ ä¸­ |

---

## ğŸ› ï¸ ä¿®å¾©æ–¹æ¡ˆ

### **æ–¹æ¡ˆ Aï¼šä¿å®ˆä¿®å¾©**ï¼ˆæ¨è–¦ï¼‰

ä½¿ç”¨æ–°é…ç½®æª”æ¡ˆ `configs/colab_piratenet_2d_slice_fixed_v2.yml`

#### é—œéµä¿®æ”¹ï¼š
```yaml
# 1. é™ä½å­¸ç¿’ç‡
optimizer:
  lr: 1.0e-4  # åŸ 1e-3

# 2. å¼·åŒ–æ¢¯åº¦è£å‰ª
gradient_clip: 0.5  # åŸ 1.0

# 3. é™ä½ batch size
batch_size: 1024  # åŸ 2048

# 4. æ˜ç¢ºå•Ÿç”¨è³‡æ–™æ­¸ä¸€åŒ–
normalization:
  enabled: true
  method: "z_score"
  per_variable: true

# 5. ä½¿ç”¨æ›´ç©©å®šçš„æ¿€æ´»å‡½æ•¸
activation: "tanh"  # åŸ swish

# 6. é™ä½ Fourier sigma
fourier_sigma: 1.0  # åŸ 2.0

# 7. åˆæœŸé—œé–‰è‡ªé©æ‡‰æ¬Šé‡
adaptive_weights:
  enabled: false  # ç­‰ç©©å®šå¾Œå†å•Ÿç”¨

# 8. å¢åŠ  warmup
warmup_epochs: 50  # åŸ 20
```

#### è¨“ç·´æŒ‡ä»¤ï¼š
```bash
# Colab ä¸­åŸ·è¡Œ
!python scripts/train.py --cfg configs/colab_piratenet_2d_slice_fixed_v2.yml

# ç›£æ§è¨“ç·´ï¼ˆæ¯ 10 epochs åŸ·è¡Œï¼‰
!tail -30 log/colab_piratenet_2d_fixed_v2/training.log
```

#### æˆåŠŸæŒ‡æ¨™ï¼š
- âœ… å‰ 100 epochs ç„¡ NaN loss
- âœ… `gradient_norm < 10.0`
- âœ… `total_loss` ç©©å®šä¸‹é™
- âœ… `wall_loss > 0` ä¸”ç©©å®š

---

### **æ–¹æ¡ˆ Bï¼šéšæ®µå¼ä¿®å¾©**ï¼ˆè‹¥æ–¹æ¡ˆ A ä»å¤±æ•—ï¼‰

#### éšæ®µ 1ï¼šæœ€å°å¯è¨“ç·´é…ç½®ï¼ˆ200 epochsï¼‰
```yaml
# æ¥µä¿å®ˆè¨­å®š
optimizer:
  lr: 5.0e-5  # é€²ä¸€æ­¥é™ä½

batch_size: 512  # é€²ä¸€æ­¥é™ä½

gradient_clip: 0.3  # é€²ä¸€æ­¥é™ä½

# é—œé–‰æ‰€æœ‰é«˜ç´šç‰¹æ€§
use_rwf: false
use_fourier: false
adaptive_weights:
  enabled: false
causal_weights:
  enabled: false
```

#### éšæ®µ 2ï¼šé€æ­¥å•Ÿç”¨ç‰¹æ€§ï¼ˆ200-500 epochsï¼‰
è‹¥éšæ®µ 1 ç©©å®šï¼ˆloss æŒçºŒä¸‹é™ï¼‰ï¼Œé€æ­¥å•Ÿç”¨ï¼š
1. Fourier featuresï¼ˆepoch 200ï¼‰
2. RWFï¼ˆepoch 300ï¼‰
3. æå‡ batch size åˆ° 1024ï¼ˆepoch 400ï¼‰

#### éšæ®µ 3ï¼šå®Œæ•´è¨“ç·´ï¼ˆ500-1000 epochsï¼‰
å•Ÿç”¨æ‰€æœ‰ç‰¹æ€§ä¸¦å¾®èª¿è‡³ç›®æ¨™èª¤å·®ã€‚

---

## ğŸ“Š è¨ºæ–·å·¥å…·ä½¿ç”¨

### 1. **è¨“ç·´å¤±æ•—è¨ºæ–·è…³æœ¬**

```bash
# å®Œæ•´è¨ºæ–·ï¼ˆç”Ÿæˆå ±å‘Š + æå¤±æ›²ç·šåœ–ï¼‰
python scripts/debug/diagnose_piratenet_failure.py \
  --checkpoint checkpoints/colab_piratenet_2d_slice/epoch_1000.pth \
  --config configs/colab_piratenet_2d_slice.yml \
  --output-dir results/piratenet_diagnosis

# æª¢æŸ¥è¼¸å‡ºï¼š
# - results/piratenet_diagnosis/diagnosis_report.json
# - results/piratenet_diagnosis/loss_history.png
```

### 2. **å¿«é€Ÿæå¤±æª¢æŸ¥**

```bash
# æå–æœ€å¾Œ 20 epochs çš„æå¤±
tail -20 log/colab_piratenet_2d_slice/training.log | grep "Epoch"

# æª¢æŸ¥æ˜¯å¦åŒ…å« NaN
grep -i "nan" log/colab_piratenet_2d_slice/training.log
```

### 3. **æ¨¡å‹æ¬Šé‡æª¢æŸ¥**

```python
import torch
import numpy as np

# è¼‰å…¥æª¢æŸ¥é»
ckpt = torch.load('checkpoints/colab_piratenet_2d_slice/epoch_100.pth', 
                  map_location='cpu')

# æª¢æŸ¥æ¬Šé‡çµ±è¨ˆ
state_dict = ckpt['model_state_dict']
for name, param in state_dict.items():
    if 'weight' in name:
        w = param.cpu().numpy()
        print(f"{name:40s} | mean: {w.mean():8.4f} | std: {w.std():8.4f} | "
              f"min: {w.min():8.4f} | max: {w.max():8.4f}")

# é æœŸï¼šå‡å€¼ ~0ï¼Œæ¨™æº–å·® ~0.1-0.5ï¼Œç„¡ NaN
```

---

## âœ… é©—è­‰æª¢æŸ¥æ¸…å–®

### **è¨“ç·´å‰**
- [ ] é…ç½®æª”æ¡ˆä¸­ `y_min: -1.0, y_max: 1.0`ï¼ˆå£é¢ä½ç½®æ­£ç¢ºï¼‰
- [ ] å­¸ç¿’ç‡ â‰¤ `1e-4`
- [ ] æ¢¯åº¦è£å‰ª â‰¤ `1.0`
- [ ] è³‡æ–™æ­¸ä¸€åŒ–å·²å•Ÿç”¨
- [ ] è³‡æ–™æª”æ¡ˆå­˜åœ¨ä¸”æ ¼å¼æ­£ç¢º

### **è¨“ç·´ä¸­**ï¼ˆæ¯ 50 epochs æª¢æŸ¥ï¼‰
- [ ] `total_loss` ç„¡ NaN/Inf
- [ ] `gradient_norm < 10.0`
- [ ] `data_loss` é€æ­¥é™ä½
- [ ] `wall_loss > 0` ä¸”ç©©å®š
- [ ] GPU è¨˜æ†¶é«”ä½¿ç”¨ < 10 GB

### **è¨“ç·´å¾Œ**
- [ ] æœ€çµ‚æå¤± < åˆå§‹æå¤±çš„ 10%
- [ ] é æ¸¬å ´ç¯„åœåˆç†ï¼ˆu âˆˆ [0, 20], v/w âˆˆ [-5, 5]ï¼‰
- [ ] ç›¸å° L2 èª¤å·® < 30%ï¼ˆ2D åˆ‡ç‰‡å¯¬é¬†æ¨™æº–ï¼‰
- [ ] çµ±è¨ˆé‡å‡å€¼èª¤å·® < 50%

---

## ğŸ”„ æ•…éšœæ’é™¤æµç¨‹åœ–

```
è¨“ç·´é–‹å§‹
    â†“
å‰ 10 epochs æª¢æŸ¥
    â†“
æ˜¯å¦å‡ºç¾ NaN? â”€â”€yesâ”€â”€> é™ä½å­¸ç¿’ç‡ï¼ˆ1e-4 â†’ 5e-5ï¼‰â”€â”
    â†“ no                                          â”‚
gradient_norm > 100? â”€â”€yesâ”€â”€> å¼·åŒ–æ¢¯åº¦è£å‰ªï¼ˆ0.5 â†’ 0.3ï¼‰â”€â”¤
    â†“ no                                              â”‚
loss æ˜¯å¦ä¸‹é™? â”€â”€noâ”€â”€> æª¢æŸ¥è³‡æ–™æ­¸ä¸€åŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â†“ yes                                             â”‚
ç¹¼çºŒè¨“ç·´è‡³ epoch 100                                  â”‚
    â†“                                                 â”‚
æª¢æŸ¥é æ¸¬å ´ç¯„åœ â”€â”€ç•°å¸¸â”€â”€> æª¢æŸ¥åæ­¸ä¸€åŒ–é‚è¼¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â†“ æ­£å¸¸                                            â”‚
ç¹¼çºŒè¨“ç·´è‡³å®Œæˆ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“š åƒè€ƒè³‡æ–™

### ç›¸é—œæª”æ¡ˆï¼š
- **è¨ºæ–·è…³æœ¬**ï¼š`scripts/debug/diagnose_piratenet_failure.py`
- **ä¿®æ­£é…ç½®**ï¼š`configs/colab_piratenet_2d_slice_fixed_v2.yml`
- **åŸå§‹é…ç½®**ï¼š`configs/colab_piratenet_2d_slice.yml`
- **è©•ä¼°è…³æœ¬**ï¼š`scripts/evaluate_piratenet_vs_jhtdb.py`

### é¡ä¼¼å•é¡Œæ¡ˆä¾‹ï¼š
- Issue #XX: "NaN loss in VS-PINN training"
- Issue #YY: "Gradient explosion with Fourier features"

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡Œå‹•

### ç«‹å³åŸ·è¡Œï¼š
1. âœ… ä½¿ç”¨ `colab_piratenet_2d_slice_fixed_v2.yml` é‡æ–°è¨“ç·´
2. âœ… å‰ 100 epochs å¯†åˆ‡ç›£æ§æå¤±
3. âœ… è‹¥ç©©å®šï¼Œç¹¼çºŒè¨“ç·´è‡³ 1000 epochs

### è‹¥ä»å¤±æ•—ï¼š
1. åŸ·è¡Œè¨ºæ–·è…³æœ¬ä¸¦æª¢æŸ¥å ±å‘Š
2. æ¡ç”¨æ–¹æ¡ˆ Bï¼ˆéšæ®µå¼ä¿®å¾©ï¼‰
3. è€ƒæ…®ä½¿ç”¨æ›´ç°¡å–®çš„æ¨¡å‹æ¶æ§‹ï¼ˆé™ä½å¯¬åº¦/æ·±åº¦ï¼‰

### æˆåŠŸå¾Œï¼š
1. è©•ä¼° 2D åˆ‡ç‰‡çµæœ
2. è‹¥é”æ¨™ï¼ˆL2 < 20%ï¼‰ï¼Œå‡ç´šè‡³ 3D å®Œæ•´è¨“ç·´
3. è¨˜éŒ„æˆåŠŸé…ç½®ä¸¦æ›´æ–°æ–‡æª”

---

## ğŸ“ å–å¾—å”åŠ©

è‹¥å•é¡ŒæŒçºŒå­˜åœ¨ï¼Œè«‹æä¾›ï¼š
1. å®Œæ•´çš„è¨“ç·´æ—¥èªŒï¼ˆå‰ 50 + æœ€å¾Œ 50 è¡Œï¼‰
2. è¨ºæ–·è…³æœ¬è¼¸å‡º
3. æª¢æŸ¥é»æª”æ¡ˆçš„æ¬Šé‡çµ±è¨ˆ
4. ä½¿ç”¨çš„é…ç½®æª”æ¡ˆ

**æ–‡æª”ç‰ˆæœ¬**ï¼šv2.0  
**æ›´æ–°æ—¥æœŸ**ï¼š2025-10-16
