# JHTDB API å•é¡Œè¨ºæ–·å ±å‘Š

## ğŸ“… æ—¥æœŸï¼š2025-10-16

## ğŸ¯ ç›®æ¨™
å¾ JHTDB ç²å–çœŸå¯¦çš„å¤šæ™‚é–“æ­¥æ•¸æ“šï¼ˆ50 å€‹æ™‚é–“æ­¥ï¼‰ï¼Œç”¨æ–¼ QR-Pivot æ„Ÿæ¸¬é»é¸æ“‡ï¼Œä»¥é™ä½æ¢ä»¶æ•¸ã€‚

## âŒ ç™¼ç¾çš„å•é¡Œ

### 1. **HTTP API å®Œå…¨å¤±æ•ˆ**
**ç—‡ç‹€**ï¼šæ‰€æœ‰ SOAP è«‹æ±‚è¿”å› "Base64 æ•¸æ“šç‚ºç©º"

**æ¸¬è©¦ä»£ç¢¼**ï¼š
```bash
python scripts/fetch_temporal_snapshots.py \
  --mode 2d --n_time 50 --resolution 128 64 \
  --time_start 0.0 --time_end 10.0 \
  --output data/jhtdb/channel_flow_re1000/temporal/xy_n50_real.npz
```

**çµæœ**ï¼š
```
ERROR - Base64 æ•¸æ“šç‚ºç©º
ERROR - æ•¸æ“šæå–å¤±æ•—: éŸ¿æ‡‰ä¸­çš„æ•¸æ“šç‚ºç©º
WARNING - Token é©—è­‰å¤±æ•—ï¼Œå•Ÿç”¨ Mock fallback æ©Ÿåˆ¶
```

**å½±éŸ¿**ï¼šæ‰€æœ‰ç·©å­˜æ•¸æ“šï¼ˆ`data/jhtdb/cache/channel_*.h5`ï¼‰**éƒ½æ˜¯ Mock æ•¸æ“š**ï¼Œè€ŒéçœŸå¯¦ JHTDB æ•¸æ“šã€‚

---

### 2. **ç‰©ç†åº§æ¨™è½‰æ›é‚è¼¯éŒ¯èª¤**
**ä½ç½®**ï¼š`pinnx/dataio/jhtdb_client.py` ç¬¬ 986 è¡Œ

**éŒ¯èª¤ä»£ç¢¼**ï¼š
```python
start_int = [max(1, int(s) + 1) for s in start]
```

**å•é¡Œ**ï¼š
- ç›´æ¥å°‡ç‰©ç†åº§æ¨™ï¼ˆå¦‚ `0.0, -1.0, 4.558`ï¼‰è½‰ç‚ºæ•´æ•¸ï¼Œæœªè€ƒæ…®æ•¸æ“šé›†çš„ç‰©ç†ç¯„åœ
- Channel Flow çš„ç¯„åœï¼š`L_x Ã— L_y Ã— L_z = 8Ï€ Ã— 2 Ã— 3Ï€`
- ç¶²æ ¼ï¼š`2048 Ã— 512 Ã— 1536`

**æ­£ç¢ºè½‰æ›æ‡‰ç‚º**ï¼š
```python
# ç‰©ç†åº§æ¨™ â†’ ç¶²æ ¼ç´¢å¼•
L = [8*np.pi, 2, 3*np.pi]  # ç‰©ç†ç¯„åœ
N = [2048, 512, 1536]      # ç¶²æ ¼è§£æåº¦
start_int = [max(1, int((s / L[i]) * N[i]) + 1) for i, s in enumerate(start)]
```

---

### 3. **pyJHTDB ä¸å…¼å®¹**
**ç—‡ç‹€**ï¼š`pip install pyJHTDB` å¤±æ•—

**éŒ¯èª¤**ï¼š
```python
AttributeError: module 'numpy' has no attribute 'int'.
`np.int` was a deprecated alias for the builtin `int`.
```

**åŸå› **ï¼špyJHTDB ä½¿ç”¨äº†å·²æ£„ç”¨çš„ `np.int`ï¼ˆNumPy 1.20 å¾Œç§»é™¤ï¼‰

**å¯èƒ½è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. å¾æºç¢¼å®‰è£ä¿®æ”¹å¾Œçš„ pyJHTDBï¼ˆæ›¿æ› `np.int` â†’ `int`ï¼‰
2. é™ç´š NumPy åˆ° < 1.20ï¼ˆä¸æ¨è–¦ï¼Œæœƒç ´å£å…¶ä»–ä¾è³´ï¼‰

---

## ğŸ” è¨ºæ–·è­‰æ“š

### ç·©å­˜æ•¸æ“šå®Œå…¨ç›¸åŒ
```bash
# æª¢æŸ¥å‰ 5 å€‹ç·©å­˜æ–‡ä»¶
python3 -c "
import h5py, glob, numpy as np
files = sorted(glob.glob('data/jhtdb/cache/channel_*.h5'))[:5]
for f in files:
    with h5py.File(f, 'r') as h:
        u = h['u'][:]
        print(f'{f.split(\"/\")[-1][:30]}: mean={u.mean():.4f}')
"
```

**è¼¸å‡º**ï¼š
```
channel_03c1e76d2a7afc6d7367c4: mean=9.8408
channel_0b14aae916449784a3c243: mean=9.8408
channel_0d9cefe09ff14340802bcd: mean=9.8408
channel_0f650bf764473f2b7b1401: mean=9.8408
channel_113a121688123c807634bb: mean=9.8408
```

**çµè«–**ï¼šæ‰€æœ‰æ–‡ä»¶çµ±è¨ˆé‡**å®Œå…¨ç›¸åŒ** â†’ Mock fallback ç”Ÿæˆäº†é‡è¤‡æ•¸æ“š

---

### æ™‚é–“æ­¥å…ƒæ•¸æ“šæ­£ç¢ºï¼Œä½†æ•¸æ“šç›¸åŒ
```bash
# æª¢æŸ¥å…ƒæ•¸æ“šä¸­çš„ timestep
python3 -c "
import h5py, json, glob
files = sorted(glob.glob('data/jhtdb/cache/channel_*.h5'))[:5]
for f in files:
    with h5py.File(f, 'r') as h:
        params = json.loads(h.attrs['query_params'])
        print(f'timestep={params[\"timestep\"]:4d}')
"
```

**è¼¸å‡º**ï¼š
```
timestep= 125
timestep=1318
timestep= 533
timestep=1193
timestep=1004
```

**çµè«–**ï¼šæ™‚é–“æ­¥åƒæ•¸**ä¸åŒ**ï¼Œä½†æ•¸æ“š**ç›¸åŒ** â†’ API è«‹æ±‚å¤±æ•—å¾Œï¼Œfallback ç”Ÿæˆäº†**ç›¸åŒçš„**æ¨¡æ“¬æ•¸æ“š

---

## âœ… å·²å®Œæˆçš„ä¿®å¾©

### ä¿®å¾© 1ï¼šæ•¸æ“šæå–é‚è¼¯
**æ–‡ä»¶**ï¼š`scripts/fetch_temporal_snapshots.py` ç¬¬ 155-167 è¡Œ

**åŸå§‹ä»£ç¢¼**ï¼ˆéŒ¯èª¤ï¼‰ï¼š
```python
data = manager.fetch_cutout(...)
u_snapshots[i] = data['u'].squeeze()  # âŒ KeyError: 'u'
```

**ä¿®æ­£å¾Œ**ï¼š
```python
result = manager.fetch_cutout(...)
data = result['data']  # âœ… æ­£ç¢ºè¨ªå•æ•¸æ“š
u_snapshots[i] = data['u'].squeeze()
logger.info(f"ä¾†æº: {'ç·©å­˜' if result.get('from_cache') else 'JHTDB API'}")
```

**ç‹€æ…‹**ï¼šâœ… å·²ä¿®å¾©ä¸¦é©—è­‰

---

## ğŸš§ å¾…ä¿®å¾©å•é¡Œ

### å„ªå…ˆç´š 1ï¼šä¿®å¾© HTTP API åº§æ¨™è½‰æ›
**ä»»å‹™**ï¼šä¿®æ”¹ `pinnx/dataio/jhtdb_client.py` ç¬¬ 979-1027 è¡Œ

**éœ€è¦çš„æ•¸æ“š**ï¼š
- Channel Flow ç‰©ç†ç¯„åœï¼š`[8Ï€, 2, 3Ï€]`
- ç¶²æ ¼è§£æåº¦ï¼š`[2048, 512, 1536]`

**ä¿®å¾©è¨ˆç•«**ï¼š
1. å‰µå»ºæ•¸æ“šé›†é…ç½®æ˜ å°„ï¼ˆç‰©ç†ç¯„åœ + ç¶²æ ¼è§£æåº¦ï¼‰
2. ä¿®æ”¹ `_call_get_any_cutout_web()` çš„åº§æ¨™è½‰æ›é‚è¼¯
3. æ·»åŠ å–®å…ƒæ¸¬è©¦é©—è­‰è½‰æ›æ­£ç¢ºæ€§

**é ä¼°æ™‚é–“**ï¼š1-2 å°æ™‚

---

### å„ªå…ˆç´š 2ï¼šä¿®å¾© pyJHTDB å…¼å®¹æ€§
**ä»»å‹™**ï¼šå¾æºç¢¼å®‰è£ä¿®æ”¹å¾Œçš„ pyJHTDB

**æ­¥é©Ÿ**ï¼š
```bash
# å…‹éš† pyJHTDB
git clone https://github.com/idies/pyJHTDB.git external/pyJHTDB
cd external/pyJHTDB

# æ›¿æ› np.int â†’ int
find . -name "*.py" -exec sed -i '' 's/np\.int,/int,/g' {} \;
find . -name "*.py" -exec sed -i '' 's/np\.int)/int)/g' {} \;

# å®‰è£
pip install -e .
```

**é ä¼°æ™‚é–“**ï¼š30 åˆ†é˜

---

## ğŸ”„ å‚™é¸æ–¹æ¡ˆ

### æ–¹æ¡ˆ Aï¼šä½¿ç”¨æ”¹é€²çš„ Mock æ•¸æ“šï¼ˆæ¨è–¦çŸ­æœŸï¼‰
**å„ªé»**ï¼š
- âœ… ç«‹å³å¯ç”¨ï¼Œç„¡éœ€ç­‰å¾… API ä¿®å¾©
- âœ… å¯é©—è­‰ QR-Pivot æµç¨‹çš„æ­£ç¢ºæ€§
- âœ… æ•¸æ“šåŒ…å«ç‰©ç†çœŸå¯¦æ€§ï¼ˆæ¹æµæ¨¡å¼ï¼‰

**ç¼ºé»**ï¼š
- âŒ ä¸æ˜¯çœŸå¯¦ JHTDB æ•¸æ“š
- âŒ ç„¡æ³•ç”¨æ–¼è«–æ–‡ç´šçµæœ

**ä½¿ç”¨æ–¹å¼**ï¼š
```bash
# å·²ç”Ÿæˆçš„ Mock æ•¸æ“šï¼ˆéœ€é‡æ–°ç”Ÿæˆæ™‚é–“æ¼”åŒ–ç‰ˆæœ¬ï¼‰
python scripts/fetch_temporal_snapshots.py \
  --mode 2d --n_time 50 --resolution 128 64 \
  --use-mock \
  --output data/jhtdb/channel_flow_re1000/temporal/xy_n50_mock_improved.npz
```

---

### æ–¹æ¡ˆ Bï¼šä½¿ç”¨å–®æ™‚é–“æ­¥çœŸå¯¦æ•¸æ“š
**æè¿°**ï¼šå¾ JHTDB ç²å–å–®å€‹æ™‚é–“æ­¥çš„å¤§ç¯„åœ cutoutï¼Œä½¿ç”¨ç©ºé–“å¤šæ¨£æ€§ä»£æ›¿æ™‚é–“æ¼”åŒ–

**å„ªé»**ï¼š
- âœ… é¿å…æ™‚é–“æ¼”åŒ–çš„ API å•é¡Œ
- âœ… ç©ºé–“å¤šæ¨£æ€§å¯èƒ½è¶³ä»¥é™ä½æ¢ä»¶æ•¸

**ç¼ºé»**ï¼š
- âŒ éœ€è¦æ›´å¤§çš„ç©ºé–“åŸŸï¼ˆå¢åŠ æ•¸æ“šé‡ï¼‰
- âŒ ç„¡æ³•æ•æ‰æ™‚é–“å‹•åŠ›å­¸ç‰¹å¾µ

**å¯¦æ–½æ–¹å¼**ï¼š
```bash
# ç²å–æ›´å¤§çš„ç©ºé–“ cutoutï¼ˆå¦‚ 256Ã—128 è€Œé 128Ã—64ï¼‰
python scripts/fetch_channel_flow.py \
  --mode cutout \
  --resolution 256 128 --z_pos 4.558 \
  --output data/jhtdb/channel_flow_re1000/slices/xy_pos4.558_256x128.npz
```

---

### æ–¹æ¡ˆ Cï¼šå®Œæ•´ä¿®å¾© JHTDB APIï¼ˆæ¨è–¦é•·æœŸï¼‰
**ä»»å‹™æ¸…å–®**ï¼š
1. âœ… ä¿®å¾©æ•¸æ“šæå–é‚è¼¯ï¼ˆå·²å®Œæˆï¼‰
2. ğŸš§ ä¿®å¾©åº§æ¨™è½‰æ›é‚è¼¯ï¼ˆå„ªå…ˆç´š 1ï¼‰
3. ğŸš§ ä¿®å¾© pyJHTDB å…¼å®¹æ€§ï¼ˆå„ªå…ˆç´š 2ï¼‰
4. ğŸ”² æ·»åŠ å®Œæ•´çš„é›†æˆæ¸¬è©¦
5. ğŸ”² æ›´æ–°æ–‡æª”

**é ä¼°ç¸½æ™‚é–“**ï¼š3-4 å°æ™‚

---

## ğŸ“Š æ¢ä»¶æ•¸æ¯”è¼ƒ

| æ•¸æ“šä¾†æº | æ¢ä»¶æ•¸ | ç‹€æ…‹ | å‚™è¨» |
|---------|--------|------|------|
| **Mock æ•¸æ“šï¼ˆç•¶å‰ï¼‰** | `1.9e+16` | âŒ å¤±æ•— | æ‰€æœ‰æ™‚é–“æ­¥ç›¸åŒ â†’ ç§©=1 |
| **Mock æ•¸æ“šï¼ˆç†è«–ï¼‰** | `~1e+4` | ğŸ”² æœªæ¸¬è©¦ | éœ€é‡æ–°ç”Ÿæˆæ™‚é–“æ¼”åŒ–ç‰ˆæœ¬ |
| **çœŸå¯¦ JHTDBï¼ˆç›®æ¨™ï¼‰** | `<100` | ğŸ”² æœªæ¸¬è©¦ | éœ€ä¿®å¾© API |

---

## ğŸ¯ å»ºè­°ä¸‹ä¸€æ­¥

### çŸ­æœŸï¼ˆä»Šæ—¥ï¼‰ï¼š
1. **ç”Ÿæˆæ”¹é€²çš„ Mock æ•¸æ“š**ï¼ˆåŒ…å«çœŸå¯¦æ™‚é–“æ¼”åŒ–ï¼‰
2. **é©—è­‰ QR-Pivot æµç¨‹**èƒ½æ­£ç¢ºé™ä½æ¢ä»¶æ•¸
3. **è¨˜éŒ„ç•¶å‰é€²åº¦**åˆ° `context/decisions_log.md`

### ä¸­æœŸï¼ˆæœ¬å‘¨ï¼‰ï¼š
1. **ä¿®å¾© HTTP API åº§æ¨™è½‰æ›**ï¼ˆå„ªå…ˆç´š 1ï¼‰
2. **å®‰è£ä¿®æ”¹å¾Œçš„ pyJHTDB**ï¼ˆå„ªå…ˆç´š 2ï¼‰
3. **é‡æ–°æ¸¬è©¦çœŸå¯¦æ•¸æ“šç²å–**

### é•·æœŸï¼ˆè«–æ–‡ï¼‰ï¼š
1. **å®Œæ•´é›†æˆæ¸¬è©¦**ï¼ˆçœŸå¯¦æ•¸æ“š + QR-Pivotï¼‰
2. **æ€§èƒ½åŸºæº–æ¸¬è©¦**ï¼ˆæ¢ä»¶æ•¸ vs Kï¼‰
3. **æ–‡æª”èˆ‡å¯é‡ç¾æ€§**

---

## ğŸ“ åƒè€ƒè³‡æ–™

- **JHTDB å®˜æ–¹æ–‡æª”**ï¼šhttp://turbulence.pha.jhu.edu/
- **GetAnyCutoutWeb API**ï¼šhttp://turbulence.pha.jhu.edu/webquery/query.aspx
- **pyJHTDB GitHub**ï¼šhttps://github.com/idies/pyJHTDB
- **Channel Flow åƒæ•¸**ï¼š`AGENTS.md` ç¬¬ X è¡Œ

---

## âœï¸ è¨˜éŒ„è€…
- **æ—¥æœŸ**ï¼š2025-10-16
- **æœƒè©±**ï¼šQR-Pivot æ¢ä»¶æ•¸æ”¹é€²
- **ç›¸é—œä»»å‹™**ï¼šTASK-QR-IMPROVEMENT-001
