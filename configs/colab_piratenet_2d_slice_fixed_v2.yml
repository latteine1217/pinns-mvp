# ========================================
# PirateNet Google Colab é…ç½® - 2D åˆ‡ç‰‡ç‰ˆ (ä¿®æ­£ç‰ˆ v2)
# ========================================
# ç”¨é€”ï¼šä½è¨˜æ†¶é«” Colab è¨“ç·´ï¼Œä¿®å¾© NaN loss å•é¡Œ
# é æœŸæ™‚é–“ï¼š30-60 åˆ†é˜ï¼ˆ1000 epochs, T4 GPUï¼‰
# ç›®æ¨™ï¼šL2 èª¤å·® â‰¤ 20%ï¼ˆ2D åˆ‡ç‰‡è¼ƒå¯¬é¬†ï¼‰
# è¨˜æ†¶é«”ä½¿ç”¨ï¼š~6 GBï¼ˆé©åˆ Colab å…è²»ç‰ˆï¼‰
#
# ğŸ”§ v2 ä¿®æ­£é‡é»ï¼š
#   1. å¤§å¹…é™ä½å­¸ç¿’ç‡ (1e-3 â†’ 1e-4)
#   2. å•Ÿç”¨æ¢¯åº¦è£å‰ªä¸¦è¨­ç‚ºä¿å®ˆå€¼ (0.5)
#   3. é™ä½ batch size (2048 â†’ 1024)
#   4. ç°¡åŒ–æå¤±æ¬Šé‡é…ç½®
#   5. å¢åŠ  warmup epochs (20 â†’ 50)
#   6. æ˜ç¢ºè³‡æ–™æ­¸ä¸€åŒ–é…ç½®

experiment:
  name: "colab_piratenet_2d_fixed_v2"
  version: "v2.0"
  seed: 42
  device: "cuda"
  precision: "float32"
  description: "PirateNet 2D slice - fixed NaN loss issue"

# =============================================================================
# è³‡æ–™é…ç½®ï¼ˆ2D åˆ‡ç‰‡ï¼‰
# =============================================================================
data:
  type: "jhtdb_channel"
  dataset: "channel"
  re_tau: 1000
  
  data_dir: "./data/jhtdb"
  lowfi_dir: "./data/lowfi"
  
  # JHTDB è³‡æ–™è¼‰å…¥
  jhtdb_config:
    enabled: true
    dataset: "channel"
    re_tau: 1000
    time_step: 0.0
    use_cache: true
    
    # âœ… æ›´æ–°ç‚ºå¯¦éš› JHTDB Cutout ç¶²æ ¼
    grid_shape: [512, 128, 512]  # (Nx, Ny, Nz)
    
    # Domain configuration (å¾ integration_test_report.json)
    domain:
      x: [0.0, 25.083654403686523]  # å¯¦éš›ç¯„åœ
      y: [-1.0, 0.9998791217803955]  # âœ… æ­£ç¢ºçš„å£é¢ä½ç½®
      z: [0.0, 9.406370162963867]    # å¯¦éš›ç¯„åœ
    
    # Physical parameters
    Re_tau: 1000.0
    nu: 5.0e-5
    u_tau: 0.04997
    
    # âœ… æ–°å¢ï¼šHDF5 æª”æ¡ˆè·¯å¾‘
    data_dir: "data/jhtdb/channel_flow_re1000/raw"
    velocity_file: "JHU Turbulence Channel_velocity_t1.h5"
    pressure_file: "JHU Turbulence Channel_pressure_t1.h5"
  
  # Top-level domain (for physics module - å¾å¯¦éš› JHTDB æ•¸æ“š)
  domain:
    x_min: 0.0
    x_max: 25.083654403686523
    y_min: -1.0
    y_max: 0.9998791217803955
    z_min: 0.0
    z_max: 9.406370162963867
  
  # ğŸ”§ 2D åˆ‡ç‰‡é…ç½®
  slice_2d:
    enabled: true
    plane: "xy"  # ä¸»å‰ªåˆ‡å¹³é¢ï¼ˆx-y å¹³é¢ï¼‰
    z_position: 4.703  # z ä¸­å¿ƒä½ç½®ï¼ˆåŸŸç¯„åœçš„ä¸­é»ï¼‰
    steady_state: true
    time_average_window: [20.0, 26.0]
  
  # ğŸ”§ v2: é™ä½è³‡æ–™é»æ•¸ä»¥æå‡ç©©å®šæ€§
  num_sensors: 50
  sensor_type: "qr_pivot"
  sensor_noise: 0.01
  
  num_collocation: 2048  # âœ… é™ä½ï¼ˆåŸ 4096ï¼‰
  num_boundary: 128      # âœ… é™ä½ï¼ˆåŸ 256ï¼‰
  num_initial: 64        # âœ… é™ä½ï¼ˆåŸ 128ï¼‰
  
  # ğŸ”§ v2: æ˜ç¢ºå•Ÿç”¨è³‡æ–™æ­¸ä¸€åŒ–
  normalization:
    enabled: true
    method: "z_score"  # æ¨™æº–åŒ–åˆ°å‡å€¼ 0ã€æ¨™æº–å·® 1
    per_variable: true
    
    # âœ… ä½¿ç”¨å¯¦éš› JHTDB Cutout çµ±è¨ˆé‡ï¼ˆå¾ integration_test_report.jsonï¼‰
    reference_stats:
      u_mean: 0.729   # å¾æ•´åˆæ¸¬è©¦æå–çš„æ„Ÿæ¸¬é»å‡å€¼
      u_std: 0.439
      v_mean: -0.002
      v_std: 0.033
      w_mean: 0.001
      w_std: 0.036
      p_mean: -0.002
      p_std: 0.004

# =============================================================================
# æ„Ÿæ¸¬é»é…ç½®
# =============================================================================
sensors:
  K: 50
  selection_method: "qr_pivot"
  spatial_coverage: "optimal"

# =============================================================================
# æ¨¡å‹æ¶æ§‹ï¼ˆPirateNet æ¨™æº–é…ç½® - ä¿å®ˆç‰ˆï¼‰
# =============================================================================
model:
  type: "enhanced_fourier_mlp"
  
  in_dim: 3   # (x, y, z) - å³ä½¿æ˜¯ 2D åˆ‡ç‰‡ä¹Ÿä¿ç•™ z åº§æ¨™
  out_dim: 4  # (u, v, w, p)
  depth: 6    # PirateNet: 2 residual blocks Ã— 3 layers
  width: 512  # ğŸ”§ v2: é™ä½å¯¬åº¦ (768 â†’ 512) ä»¥æå‡ç©©å®šæ€§
  
  activation: "tanh"  # ğŸ”§ v2: ä½¿ç”¨ tanh (æ›´ç©©å®šæ–¼ swish)
  
  # Fourier Featuresï¼ˆPirateNet RFF é…ç½®ï¼‰
  use_fourier: true
  fourier_m: 64
  fourier_sigma: 1.0  # ğŸ”§ v2: é™ä½ Ïƒ (2.0 â†’ 1.0)
  fourier_multiscale: false
  trainable_fourier: false
  
  # RWFï¼ˆPirateNet æ¬Šé‡å› å­åŒ–ï¼‰
  use_rwf: true
  rwf_scale_mean: 1.0
  rwf_scale_std: 0.05  # ğŸ”§ v2: é™ä½è®Šç•°æ€§ (0.1 â†’ 0.05)
  
  use_residual: true
  use_layer_norm: true
  dropout: 0.0
  
  # ğŸ”§ v2: æ¬Šé‡åˆå§‹åŒ–é…ç½®
  init_method: "xavier_uniform"  # æ›´ç©©å®šçš„åˆå§‹åŒ–
  init_gain: 0.5  # ä¿å®ˆçš„å¢ç›Š

# =============================================================================
# è¨“ç·´é…ç½®ï¼ˆColab å„ªåŒ– + æ•¸å€¼ç©©å®šæ€§å¼·åŒ–ï¼‰
# =============================================================================
training:
  epochs: 1000
  batch_size: 1024  # ğŸ”§ v2: é™ä½ (2048 â†’ 1024)
  
  # å„ªåŒ–å™¨
  optimizer:
    type: "adam"
    lr: 1.0e-4  # ğŸ”§ v2: é™ä½å­¸ç¿’ç‡ (1e-3 â†’ 1e-4)
    betas: [0.9, 0.999]
    eps: 1.0e-8
    weight_decay: 0.0
    amsgrad: false  # ä¿æŒç°¡å–®
  
  # ğŸ”§ v2: æ›´ä¿å®ˆçš„å­¸ç¿’ç‡èª¿åº¦
  scheduler:
    type: "warmup_exponential"
    warmup_epochs: 50  # ğŸ”§ å¢åŠ  warmup (20 â†’ 50)
    decay_rate: 0.95   # ğŸ”§ æ›´ç·©æ…¢çš„è¡°æ¸› (0.9 â†’ 0.95)
    decay_epochs: 50
    min_lr: 1.0e-7
  
  # æ¡æ¨£é…ç½®
  sampling:
    pde_points: 2048       # ğŸ”§ é™ä½
    boundary_points: 128   # ğŸ”§ é™ä½
    wall_clustering: 0.3
  
  validation_freq: 50
  checkpoint_freq: 100
  log_interval: 10
  
  # ğŸ”§ v2: é—œéµä¿®å¾© - å¼·åŒ–æ¢¯åº¦è£å‰ª
  gradient_clip: 0.5  # ğŸ”§ æ›´ä¿å®ˆçš„è£å‰ªå€¼
  gradient_clip_norm_type: 2.0  # L2 norm
  
  # ğŸ”§ v2: æå¤±ç¸®æ”¾ï¼ˆé˜²æ­¢æ•¸å€¼ä¸‹æº¢ï¼‰
  loss_scaling: 1.0  # è‹¥ä»æœ‰å•é¡Œå¯èª¿æ•´ç‚º 10.0

# =============================================================================
# æå¤±æ¬Šé‡ï¼ˆç°¡åŒ–ç‰ˆ - é¿å…è¤‡é›œçš„è‡ªé©æ‡‰æ©Ÿåˆ¶ï¼‰
# =============================================================================
losses:
  # ğŸ”§ v2: ç°¡åŒ–æ¬Šé‡é…ç½®ï¼ŒåˆæœŸä¸ä½¿ç”¨è‡ªé©æ‡‰
  data_loss_weight: 100.0  # ğŸ”§ æé«˜è³‡æ–™ä¸€è‡´æ€§æ¬Šé‡
  pde_loss_weight: 1.0
  wall_loss_weight: 50.0   # ğŸ”§ æé«˜å£é¢é‚Šç•Œæ¬Šé‡
  initial_loss_weight: 100.0
  prior_weight: 0.0  # ğŸ”§ v2: åˆæœŸé—œé–‰ä½ä¿çœŸå…ˆé©—
  
  # ğŸ”§ v2: éšæ®µ 1 ä¸ä½¿ç”¨è‡ªé©æ‡‰æ¬Šé‡ï¼ˆç­‰ç©©å®šå¾Œå†å•Ÿç”¨ï¼‰
  adaptive_weights:
    enabled: false  # ğŸ”§ å…ˆé—œé–‰
    method: "gradnorm"
    alpha: 1.5
    update_frequency: 100
  
  # ğŸ”§ v2: å› æœæ¬Šé‡ä¹Ÿå…ˆé—œé–‰
  causal_weights:
    enabled: false  # ğŸ”§ å…ˆé—œé–‰
    epsilon: 1.0
    tol: 0.1

# =============================================================================
# ç‰©ç†é…ç½®ï¼ˆ2D åˆ‡ç‰‡ï¼‰
# =============================================================================
physics:
  type: "vs_pinn_channel_flow"
  nu: 5.0e-5
  re_tau: 1000
  u_tau: 0.04997
  
  # åŸŸç¯„åœ (å¾å¯¦éš› JHTDB æ•¸æ“š)
  domain:
    x_min: 0.0
    x_max: 25.083654403686523
    y_min: -1.0
    y_max: 0.9998791217803955
    z_min: 0.0
    z_max: 9.406370162963867
  
  # VS-PINN ç¸®æ”¾å› å­ï¼ˆ2D åˆ‡ç‰‡ï¼‰
  scaling:
    use_scaling: true
    N_x: 2.0   # æµå‘é©åº¦ç¸®æ”¾
    N_y: 8.0   # ğŸ”§ v2: é™ä½ y æ–¹å‘ç¸®æ”¾ (12 â†’ 8)
    N_z: 1.0   # 2D åˆ‡ç‰‡ï¼šz æ–¹å‘ä¸ç¸®æ”¾

# =============================================================================
# è¼¸å‡ºé…ç½®
# =============================================================================
output:
  checkpoint_dir: "./checkpoints/colab_piratenet_2d_fixed_v2"
  results_dir: "./results/colab_piratenet_2d_fixed_v2"
  visualization_dir: "./results/colab_piratenet_2d_fixed_v2/visualizations"
  save_predictions: true
  save_frequency: 100

# =============================================================================
# æ—¥èªŒé…ç½®
# =============================================================================
logging:
  level: "info"
  log_freq: 10
  tensorboard: true
  wandb: false
  
  metrics:
    - "total_loss"
    - "data_loss"
    - "pde_loss"
    - "wall_loss"
    - "learning_rate"
    - "gradient_norm"  # ğŸ”§ v2: ç›£æ§æ¢¯åº¦ç¯„æ•¸

# =============================================================================
# æ—©åœé…ç½®
# =============================================================================
early_stopping:
  enabled: true
  patience: 300  # ğŸ”§ v2: å¢åŠ è€å¿ƒ (200 â†’ 300)
  min_delta: 1.0e-6  # ğŸ”§ æ”¾å¯¬å®¹å¿åº¦
  monitor: "total_loss"

# =============================================================================
# å¯é‡ç¾æ€§é…ç½®
# =============================================================================
reproducibility:
  deterministic: true
  benchmark: false

# =============================================================================
# Colab å°ˆç”¨è¨­å®š
# =============================================================================
colab:
  mount_gdrive: true
  gdrive_checkpoint_dir: "/content/drive/MyDrive/pinns-mvp/checkpoints/colab_piratenet_2d_fixed_v2"
  auto_save_interval: 100
  
  monitor_gpu: true
  monitor_interval: 50
  
  auto_resume: true
  resume_from_gdrive: true

# =============================================================================
# ä½¿ç”¨èªªæ˜
# =============================================================================
usage_notes: |
  ğŸ¯ v2 ä¿®æ­£ç‰ˆè¨“ç·´æŒ‡å—ï¼š
  
  âœ… é—œéµä¿®æ­£ï¼ˆé‡å° NaN loss å•é¡Œï¼‰ï¼š
    1. é™ä½å­¸ç¿’ç‡ (1e-3 â†’ 1e-4)
    2. å¼·åŒ–æ¢¯åº¦è£å‰ª (1.0 â†’ 0.5)
    3. é™ä½ batch size (2048 â†’ 1024)
    4. é™ä½æ¨¡å‹å¯¬åº¦ (768 â†’ 512)
    5. ä½¿ç”¨ tanh æ¿€æ´»å‡½æ•¸ï¼ˆæ›´ç©©å®šï¼‰
    6. ç°¡åŒ–æå¤±æ¬Šé‡ï¼ˆé—œé–‰è‡ªé©æ‡‰æ©Ÿåˆ¶ï¼‰
    7. å¢åŠ  warmup epochs (20 â†’ 50)
    8. æ˜ç¢ºå•Ÿç”¨è³‡æ–™æ­¸ä¸€åŒ–
  
  ğŸ“Š é æœŸçµæœï¼ˆ1000 epochsï¼‰ï¼š
    - è¨“ç·´æ™‚é–“ï¼š40-70 åˆ†é˜ï¼ˆT4 GPUï¼‰
    - ç›®æ¨™ L2ï¼šâ‰¤ 20%ï¼ˆ2D åˆ‡ç‰‡ï¼‰
    - è¨˜æ†¶é«”å³°å€¼ï¼š~6 GB
    - æå¤±æ›²ç·šï¼šç©©å®šä¸‹é™ï¼Œç„¡ NaN
  
  ğŸš€ ä½¿ç”¨å‘½ä»¤ï¼š
    # Colab ä¸­åŸ·è¡Œ
    !python scripts/train.py --cfg configs/colab_piratenet_2d_slice_fixed_v2.yml
  
  ğŸ“ˆ é©—è­‰æ˜¯å¦ä¿®æ­£æˆåŠŸï¼š
    # æª¢æŸ¥å‰ 100 epochs çš„æå¤±
    !python scripts/debug/diagnose_piratenet_failure.py \
      --checkpoint checkpoints/colab_piratenet_2d_fixed_v2/epoch_100.pth \
      --config configs/colab_piratenet_2d_slice_fixed_v2.yml
    
    # é—œéµæŒ‡æ¨™ï¼š
    # 1. total_loss ç©©å®šä¸‹é™ï¼ˆç„¡ NaN/Infï¼‰
    # 2. gradient_norm < 10.0ï¼ˆæ¢¯åº¦ç©©å®šï¼‰
    # 3. wall_loss > 0ï¼ˆå£é¢é‚Šç•Œç”Ÿæ•ˆï¼‰
  
  âš ï¸ è‹¥ä»å‡ºç¾ NaNï¼š
    1. é€²ä¸€æ­¥é™ä½å­¸ç¿’ç‡ â†’ 5e-5
    2. æ¸›å° Fourier sigma â†’ 0.5
    3. é™ä½ batch size â†’ 512
    4. æª¢æŸ¥è³‡æ–™æ˜¯å¦åŒ…å«ç•°å¸¸å€¼
  
  ğŸ”„ éšæ®µå¼è¨“ç·´ç­–ç•¥ï¼š
    # éšæ®µ 1 (0-200 epochs): ç©©å®šè¨“ç·´ï¼Œç¢ºä¿ç„¡ NaN
    # éšæ®µ 2 (200-500 epochs): è‹¥ç©©å®šï¼Œå¯å•Ÿç”¨ GradNorm
    # éšæ®µ 3 (500-1000 epochs): ç²¾ç´°èª¿æ•´ï¼Œæ”¶æ–‚åˆ°ç›®æ¨™èª¤å·®

# =============================================================================
# å¿«é€Ÿå•Ÿå‹•å‘½ä»¤ï¼ˆè¤‡è£½åˆ° Colabï¼‰
# =============================================================================
quick_start_commands: |
  # 1. æ›è¼‰ Google Drive
  from google.colab import drive
  drive.mount('/content/drive')
  
  # 2. å…‹éš†å°ˆæ¡ˆ
  !git clone https://github.com/your-repo/pinns-mvp.git
  %cd pinns-mvp
  
  # 3. å®‰è£ä¾è³´
  !pip install -q torch torchvision torchaudio
  !pip install -q pyJHTDB h5py pyyaml tensorboard
  
  # 4. ä¸‹è¼‰æ•¸æ“šï¼ˆ2D åˆ‡ç‰‡ï¼‰
  !mkdir -p data/jhtdb/channel_flow_re1000
  !python scripts/fetch_channel_flow.py --K 50 --slice-2d
  
  # 5. é–‹å§‹è¨“ç·´ï¼ˆv2 ä¿®æ­£ç‰ˆï¼‰
  !python scripts/train.py --cfg configs/colab_piratenet_2d_slice_fixed_v2.yml
  
  # 6. ç›£æ§è¨“ç·´ï¼ˆæ–° Cellï¼‰
  %load_ext tensorboard
  %tensorboard --logdir ./checkpoints/colab_piratenet_2d_fixed_v2
  
  # 7. æ¯ 100 epochs æª¢æŸ¥ä¸€æ¬¡ï¼ˆæ–° Cellï¼Œé‡è¤‡åŸ·è¡Œï¼‰
  !tail -30 log/colab_piratenet_2d_fixed_v2/training.log

# =============================================================================
# è¨ºæ–·æª¢æŸ¥æ¸…å–®
# =============================================================================
diagnostic_checklist: |
  è¨“ç·´å‰æª¢æŸ¥ï¼š
  âœ… 1. è³‡æ–™å·²æ­£ç¢ºæ­¸ä¸€åŒ–ï¼ˆå‡å€¼~0ï¼Œæ¨™æº–å·®~1ï¼‰
  âœ… 2. æ¨¡å‹æ¬Šé‡åˆå§‹åŒ–æ­£å¸¸ï¼ˆå‡å€¼~0ï¼Œæ¨™æº–å·®~0.1ï¼‰
  âœ… 3. åŸŸç¯„åœæ­£ç¢ºï¼ˆy âˆˆ [-1, 1]ï¼‰
  âœ… 4. å­¸ç¿’ç‡ä¿å®ˆï¼ˆâ‰¤ 1e-4ï¼‰
  âœ… 5. æ¢¯åº¦è£å‰ªå•Ÿç”¨ï¼ˆâ‰¤ 1.0ï¼‰
  
  è¨“ç·´ä¸­ç›£æ§ï¼ˆæ¯ 10 epochsï¼‰ï¼š
  âœ… 1. total_loss ä¸‹é™ä¸”ç„¡ NaN
  âœ… 2. gradient_norm < 10.0
  âœ… 3. data_loss é€æ­¥é™ä½
  âœ… 4. wall_loss > 0 ä¸”ç©©å®š
  âœ… 5. GPU è¨˜æ†¶é«”ä½¿ç”¨ < 10 GB
  
  è¨“ç·´å¾Œé©—è­‰ï¼š
  âœ… 1. é æ¸¬å ´ç¯„åœåˆç†ï¼ˆu âˆˆ [0, 20]ï¼‰
  âœ… 2. ç›¸å° L2 èª¤å·® < 30%ï¼ˆè‡³å°‘ï¼‰
  âœ… 3. çµ±è¨ˆé‡å‡å€¼èª¤å·® < 50%
  âœ… 4. æå¤±æ›²ç·šå…‰æ»‘ä¸‹é™
