# ========================================
# Weighting 架構整合測試配置
# ========================================
# 用途: 驗證新 weighting.py 與訓練流程的整合
# 規模: 10 epochs 快速測試

experiment:
  name: "test_weighting_integration"
  version: "v1.0"
  seed: 42
  device: "auto"
  precision: "float32"
  description: "Weighting 架構整合測試 (10 epochs)"

# 資料配置（最小規模）
data:
  type: "jhtdb_channel"
  dataset: "channel"
  re_tau: 1000
  
  data_dir: "./data/jhtdb"
  lowfi_dir: "./data/lowfi"
  
  # JHTDB 配置
  jhtdb_config:
    enabled: true
    dataset: "channel"
    re_tau: 1000
    time_step: 0.0
    use_cache: true
    
    domain:
      x: [0.0, 25.132741228718345]
      y: [0.0, 2.0]
      z: [0.0, 9.42477796076938]
    
    Re_tau: 1000.0
    nu: 5.0e-5
    u_tau: 0.04997
  
  domain:
    x_min: 0.0
    x_max: 25.132741228718345
    y_min: 0.0
    y_max: 2.0
    z_min: 0.0
    z_max: 9.42477796076938
  
  # 最小配置
  num_sensors: 16
  sensor_type: "qr_pivot"
  sensor_noise: 0.01
  
  num_collocation: 512
  num_boundary: 64
  num_initial: 32

# 感測點配置
sensors:
  K: 16
  selection_method: "qr_pivot"
  spatial_coverage: "optimal"

# 模型配置（最小規模）
model:
  type: "enhanced_fourier_mlp"
  
  in_dim: 3
  out_dim: 4
  depth: 3
  width: 128
  
  activation: "swish"
  
  use_fourier: true
  fourier_m: 16
  fourier_sigma: 2.0
  fourier_multiscale: false
  trainable_fourier: false
  
  use_rwf: false
  use_residual: false
  use_layer_norm: false
  dropout: 0.0

# 訓練配置（10 epochs 測試）
training:
  epochs: 10
  batch_size: 512
  
  optimizer:
    type: "adam"
    lr: 1.0e-3
    betas: [0.9, 0.999]
    weight_decay: 0.0
  
  scheduler:
    type: "step"
    step_size: 5
    gamma: 0.9
  
  sampling:
    pde_points: 512
    boundary_points: 64
    wall_clustering: 0.3
  
  validation_freq: 2
  checkpoint_freq: 5
  log_interval: 1

# 📊 損失權重配置（測試新架構）
losses:
  # 基礎權重
  data_weight: 100.0
  pde_weight: 1.0
  bc_weight: 10.0
  wall_constraint_weight: 10.0
  prior_weight: 0.1  # 低保真先驗權重
  
  # 細項權重（測試細粒度配置）
  momentum_x_weight: 1.0
  momentum_y_weight: 1.0
  momentum_z_weight: 1.0
  continuity_weight: 1.0
  
  # ✅ GradNorm 自適應權重（新架構測試重點）
  adaptive_weighting: true
  grad_norm_alpha: 0.12
  weight_update_freq: 5  # 每 5 步更新一次（快速觀察）
  grad_norm_min_weight: 0.1
  grad_norm_max_weight: 10.0
  
  # 指定要自適應調整的損失項
  adaptive_loss_terms:
    - "data"
    - "momentum_x"
    - "momentum_y"
    - "continuity"
    - "wall_constraint"
  
  # ✅ 因果權重（測試與 GradNorm 共存）
  causal_weighting: true
  causal_eps: 1.0
  
  # ❌ 階段式權重（與 GradNorm 互斥，測試時禁用）
  staged_weights:
    enable: false

# 物理配置
physics:
  type: "vs_pinn_channel_flow"
  nu: 5.0e-5
  re_tau: 1000
  u_tau: 0.04997
  
  domain:
    x_min: 0.0
    x_max: 25.132741228718345
    y_min: 0.0
    y_max: 2.0
    z_min: 0.0
    z_max: 9.42477796076938
  
  scaling:
    use_scaling: true
    N_x: 0.33
    N_y: 1.00
    N_z: 0.25

# 輸出配置
output:
  checkpoint_dir: "./checkpoints/test_weighting_integration"
  results_dir: "./results/test_weighting_integration"
  visualization_dir: "./results/test_weighting_integration/visualizations"
  save_predictions: false
  save_frequency: 5

# 日誌配置
logging:
  level: "info"
  log_freq: 1  # 每個 epoch 都記錄
  tensorboard: false
  wandb: false
  
  metrics:
    - "total_loss"
    - "data_loss"
    - "pde_loss"
    - "wall_loss"
    - "learning_rate"

# 早停配置（禁用）
early_stopping:
  enabled: false

# 可重現性配置
reproducibility:
  deterministic: true
  benchmark: false
