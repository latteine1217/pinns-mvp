# 🏗️ 3D Slab 課程學習模板
# 用途：課程式訓練、多階段學習、3D 流場重建
# 預期時間：30-60 分鐘（1000-2000 epochs，2 階段）
# 目標：穩健收斂、物理一致性、高精度重建

# =============================================================================
# 基本實驗設定
# =============================================================================
experiment:
  name: "3d_slab_curriculum_stage2"  # ⚠️ 修改為你的實驗名稱
  version: "v1.0"
  seed: 42
  device: "auto"
  precision: "float32"
  description: "3D slab curriculum learning with 2-stage training"

# =============================================================================
# 重現性設定
# =============================================================================
reproducibility:
  deterministic: true
  benchmark: false
  num_workers: 4

# =============================================================================
# 資料配置（3D Slab）
# =============================================================================
data:
  source: "jhtdb"
  dataset: "channel"
  
  jhtdb_config:
    enabled: true
    dataset_name: "channel"
    description: "通道流 (Re_tau=1000) - 3D Slab"
    domain:
      x: [0, 25.13]
      y: [-1.0, 1.0]
      z: [0, 9.42]
    resolution:
      x: 2048
      y: 512
      z: 1536
    time_range: [0.0, 26.0]
    dt: 0.0065
    variables: ['u', 'v', 'w', 'p']
  
  normalize: true
  cache_dir: "./data/jhtdb/channel_flow_re1000"

normalization:
  type: 'training_data_norm'
  params: {}
  noise_sigma: 0.02
  dropout_prob: 0.10
  
  # 3D Slab 配置（厚度有限）
  slice_config:
    plane: "3d_slab"
    z_range: [4.0, 5.5]  # Δz ≈ 1.5（約 16% 全域）
    steady_state: true
    time_average_window: [20.0, 26.0]

# =============================================================================
# 感測點配置
# =============================================================================
sensors:
  K: 500  # 3D 需更多感測點
  selection_method: "qr_pivot"
  spatial_coverage: "optimal"

# =============================================================================
# 模型架構（標準 3D）
# =============================================================================
model:
  type: "fourier_vs_mlp"
  in_dim: 3
  out_dim: 4
  width: 256
  depth: 6
  activation: "sine"
  
  # Fourier 特徵（3D 全激活）
  fourier_features:
    type: "axis_selective"
    axes_config: {x: [1, 2], y: [], z: [1, 2]}
    full_axes_config: {x: [1, 2, 4, 8], y: [], z: [1, 2, 4, 8]}
    domain_lengths: {x: 25.13, y: 2.0, z: 9.42}
    fourier_m: 32
    fourier_sigma: 5.0
  
  scaling:
    learnable: true
    input_norm: "channel_flow"
    output_norm: "friction_velocity"
    friction_velocity: 0.04997
    channel_half_height: 1.0
    viscous_length: 1.0e-3

# =============================================================================
# 物理設定
# =============================================================================
physics:
  type: "vs_pinn_channel_flow"
  nu: 5.0e-5
  rho: 1.0
  
  vs_pinn:
    scaling_factors:
      N_x: 2.0
      N_y: 12.0
      N_z: 2.0
    
    loss_config:
      warmup_epochs: 5
    
    boundary_config:
      boundary_band_width: 5.0e-3
    
    # ⚠️ 梯度檢查點配置（必須禁用以避免高階導數衝突）
    use_gradient_checkpointing: false  # 禁用以兼容 PINNs 高階導數
    
    enable_rans: false
  
  channel_flow:
    Re_tau: 1000.0
    Re_bulk: 39998.0
    u_tau: 0.04997
    pressure_gradient: 0.0025
    
  domain:
    x_range: [0.0, 25.13]
    y_range: [-1.0, 1.0]
    z_range: [0.0, 9.42]
    
  boundary_conditions:
    wall_velocity: [0.0, 0.0, 0.0]
    wall_location: [-1.0, 1.0]
    periodic_x: true
    periodic_z: true
    pressure_driven: true
    mean_pressure_gradient: 0.0025

# =============================================================================
# 損失函數權重（基礎配置，由課程學習覆蓋）
# =============================================================================
losses:
  data_weight: 10.0
  boundary_weight: 10.0
  
  momentum_x_weight: 1.0
  momentum_y_weight: 1.0
  momentum_z_weight: 1.0
  continuity_weight: 1.0
  
  wall_constraint_weight: 10.0
  periodicity_weight: 10.0
  pressure_gradient_weight: 1.0
  
  prior_weight: 0.3
  source_l1: 1.0e-6
  gradient_penalty: 1.0e-4
  
  # ⭐ 啟用自適應權重
  adaptive_weighting: true
  weight_update_freq: 1000
  grad_norm_alpha: 1.5
  
  adaptive_loss_terms:
    - data
    - momentum_x
    - momentum_y
    - momentum_z
    - continuity
    - wall_constraint
    - periodicity
  
  causal_weighting: false

# =============================================================================
# 訓練設定（基礎配置）
# =============================================================================
training:
  optimizer:
    type: "soap"
    lr: 1.0e-3
    weight_decay: 1.0e-5
    precondition_frequency: 2
    shampoo_beta: -1
  lr: 1.0e-3
  weight_decay: 1.0e-5
  
  lr_scheduler:
    type: "step"
    step_size: 1000
    gamma: 0.9
  
  epochs: 5000
  max_epochs: 5000
  batch_size: 1024
  validation_freq: 50
  checkpoint_freq: 100
  log_interval: 20
  
  early_stopping:
    enabled: true
    patience: 200
    min_delta: 1.0e-7
  
  sampling:
    pde_points: 10000
    boundary_points: 5000
    wall_clustering: 0.3
  
  gradient_clip: 1.0
  
  # 混合精度訓練（AMP）
  amp:
    enabled: true  # ✅ 課程學習建議啟用（長訓練時間）
    # 說明：
    #   - 3D 課程學習訓練時間較長（30-60 分鐘）
    #   - AMP 可節省 1.5-2x 時間（重要加速）
    #   - 支援多階段訓練（權重動態調整）
    #   - 已驗證課程學習兼容性

# =============================================================================
# ⭐ 課程學習配置（3 階段）
# =============================================================================
curriculum:
  enable: true
  
  stages:
    # ================================
    # 階段 1: 低 Re_tau 穩定啟動 (Epochs 0-1500)
    # ================================
    - name: "Stage1_Low_Re"
      epoch_range: [0, 1500]
      Re_tau: 500.0
      nu: 1.0e-4  # nu = (1000 * 5e-5) / 500
      pressure_gradient: 0.00125 # Scaled linearly
      lr: 1.0e-3
      
      weights:
        data: 10.0
        boundary: 10.0
        momentum_x: 1.0
        momentum_y: 1.0
        momentum_z: 1.0
        continuity: 1.0
        wall_constraint: 10.0
        periodicity: 10.0
        pressure_gradient: 1.0
      
      sampling:
        pde_points: 10000
        boundary_points: 5000
        wall_clustering: 0.3

    # ================================
    # 階段 2: 中等 Re_tau 過渡 (Epochs 1500-3500)
    # ================================
    - name: "Stage2_Mid_Re"
      epoch_range: [1500, 3500]
      Re_tau: 750.0
      nu: 6.67e-5 # nu = (1000 * 5e-5) / 750
      pressure_gradient: 0.001875 # Scaled linearly
      lr: 0.9e-3  # Decayed once
      
      weights:
        data: 10.0
        boundary: 10.0
        momentum_x: 1.0
        momentum_y: 1.0
        momentum_z: 1.0
        continuity: 1.0
        wall_constraint: 10.0
        periodicity: 10.0
        pressure_gradient: 1.0
      
      sampling:
        pde_points: 10000
        boundary_points: 5000
        wall_clustering: 0.4

    # ================================
    # 階段 3: 目標 Re_tau 精煉 (Epochs 3500-5000)
    # ================================
    - name: "Stage3_High_Re_Refinement"
      epoch_range: [3500, 5000]
      Re_tau: 1000.0
      nu: 5.0e-5
      pressure_gradient: 0.0025
      lr: 0.729e-3 # Decayed three times (0.9^3)
      
      weights:
        data: 10.0
        boundary: 10.0
        momentum_x: 1.0
        momentum_y: 1.0
        momentum_z: 1.0
        continuity: 1.0
        wall_constraint: 10.0
        periodicity: 10.0
        pressure_gradient: 1.0
      
      sampling:
        pde_points: 10000
        boundary_points: 5000
        wall_clustering: 0.5

ensemble:
  enable: false

# =============================================================================
# 評估設定
# =============================================================================
evaluation:
  grid_resolution: [128, 64, 16]  # 3D Slab 解析度
  
  metrics:
    - "relative_l2"
    - "wall_shear_stress"
    - "mass_conservation"
    - "mean_velocity_profile"
    - "turbulent_kinetic_energy"
    - "reynolds_stress"
    - "energy_spectrum"
  
  thresholds:
    l2_error: 0.25
    mass_conservation_error: 1.0e-3
    wall_shear_stress_error: 0.25
    mean_profile_correlation: 0.90

# =============================================================================
# 物理驗證（檢查點保存前）
# =============================================================================
physics_validation:
  enabled: true  # 預設啟用，確保保存的檢查點符合物理約束
  save_metrics: true  # 在檢查點元數據中記錄物理指標

  thresholds:
    mass_conservation: 1.0e-2       # 質量守恆最大散度誤差
    momentum_conservation: 1.0e-1   # 動量守恆平均殘差
    boundary_condition: 1.0e-3      # 壁面邊界條件最大誤差

  # 說明：
  #   - 若驗證失敗，檢查點保存將被拒絕並記錄警告
  #   - 可透過 enabled: false 禁用（僅用於除錯）
  #   - 閾值可根據精度需求調整

# =============================================================================
# 日誌與儲存
# =============================================================================
logging:
  level: "info"
  log_freq: 20
  save_predictions: true
  tensorboard: true
  wandb: false
  
  stage_diagnostics: true  # ⭐ 追蹤階段轉換
  save_loss_history: true
  save_weight_evolution: true

output:
  checkpoint_dir: "./checkpoints/3d_slab_curriculum_stage2"
  results_dir: "./results/3d_slab_curriculum_stage2"
  visualization_dir: "./results/3d_slab_curriculum_stage2/visualizations"
  
  save_stage_checkpoints: true  # ⭐ 保存每階段檢查點

# =============================================================================
# 驗收標準
# =============================================================================
test_acceptance:
  stability:
    - no_nan_inf: true
    - loss_finite: true
    - gradient_stable: true
    - no_mode_collapse: true
  
  performance:
    - pde_loss_ratio_target: 0.35
    - u_l2_error_target: 0.25
    - mass_conservation_error_target: 1.0e-3
    - tau_w_ratio_target: 5.0
  
  curriculum:
    - stage_transition_smooth: true  # Δloss < 20%
    - stage1_pde_ratio_min: 0.25
    - stage2_pde_ratio_min: 0.35
    - no_catastrophic_forgetting: true

# =============================================================================
# 使用說明
# =============================================================================
usage_notes: |
  🎯 用途：
    - 課程式訓練（多階段學習）
    - 3D 流場重建（Slab 域）
    - 穩健收斂策略
    - 物理一致性強化
  
  🏗️ 課程設計：
    - Stage1 (0-400 epochs): 強 PDE 暖啟，建立物理基礎
      * 初始權重平衡（data=PDE=5.0）
      * 目標：PDE ratio ≥ 25%, τ_w 非零
    
    - Stage2 (400-1000 epochs): PDE 主導精煉
      * PDE 權重提升至 8.0（+60%）
      * 降低 LR 至 3e-4（細緻調整）
      * 目標：PDE ratio ≥ 35%, L2 < 25%
  
  ⚙️ 配置特點：
    - K=100（中等稀疏度）
    - 3D Slab: 128×64×16
    - 啟用 Fourier + Adaptive
    - 2 階段課程學習
  
  ✅ 成功標準：
    1. 階段轉換平滑（Δloss < 20%）
    2. Stage1: PDE ratio ≥ 25%
    3. Stage2: PDE ratio ≥ 35%, L2 < 25%
    4. τ_w ratio ≥ 5.0（物理一致）
  
  🚀 使用範例：
    python scripts/train.py --cfg configs/templates/3d_slab_curriculum.yml
  
  📊 預期結果：
    - 訓練時間：30-60 分鐘（GPU）
    - Stage1 完成：Loss ↓ 50%, PDE ratio ≈ 25%
    - Stage2 完成：L2 ≈ 20-25%, PDE ratio ≈ 35-40%
  
  ⚠️ 注意事項：
    - 階段轉換時監控 loss 跳變（應 < 20%）
    - Stage2 若 PDE ratio 下降 > 5%，考慮調整權重
    - 壁面約束全程保持高權重（10.0）
    - 可根據需求增加至 3-4 階段

# =============================================================================
# 階段性評估計畫
# =============================================================================
evaluation_milestones:
  - epoch: 100
    stage: "Stage1"
    expected_pde_ratio: 0.15
    expected_tau_w_ratio: 0.5
    action: "確認 PDE 參與度，若 < 10% 立即調整"
  
  - epoch: 400
    stage: "Stage1 → Stage2 轉換"
    expected_pde_ratio: 0.25
    expected_tau_w_ratio: 1.0
    action: "⚠️ 關鍵檢查點：確認平滑轉換（Δloss < 20%）"
  
  - epoch: 600
    stage: "Stage2"
    expected_pde_ratio: 0.35
    expected_tau_w_ratio: 5.0
    action: "檢查 PDE 主導效果，L2 應開始顯著下降"
  
  - epoch: 1000
    stage: "Final"
    expected_pde_ratio: 0.40
    expected_tau_w_ratio: 10.0
    expected_l2: 0.25
    action: "⭐ 最終驗收：決定是否進入生產級訓練"

# =============================================================================
# 課程學習最佳實踐
# =============================================================================
curriculum_best_practices:
  stage_transition:
    - "避免權重劇烈跳變（建議 ≤ 2× 變化）"
    - "降低學習率以適應新權重配置"
    - "監控 loss 跳變（正常 < 20%）"
  
  weight_scheduling:
    - "Stage1: 平衡權重，建立物理基礎"
    - "Stage2: 提升 PDE 權重 50-100%"
    - "Stage3: 精煉階段，微調權重 ±20%"
  
  failure_modes:
    - "Stage2 PDE ratio 下降 > 5%: 權重提升不足或 LR 過高"
    - "Stage 轉換 loss 跳變 > 50%: 權重變化過激"
    - "Late stage overfitting: 提早啟用 early stopping"
