# ========================================
# PirateNet Google Colab é…ç½® - 2D åˆ‡ç‰‡ç‰ˆ
# ========================================
# ç”¨é€”ï¼šä½è¨˜æ†¶é«” Colab è¨“ç·´ï¼Œä¿®å¾©å·²çŸ¥å•é¡Œ
# é æœŸæ™‚é–“ï¼š30-60 åˆ†é˜ï¼ˆ1000 epochs, T4 GPUï¼‰
# ç›®æ¨™ï¼šL2 èª¤å·® â‰¤ 15%
# è¨˜æ†¶é«”ä½¿ç”¨ï¼š~8 GBï¼ˆé©åˆ Colab å…è²»ç‰ˆï¼‰

experiment:
  name: "colab_piratenet_2d_slice"
  version: "v1.0"
  seed: 42
  device: "cuda"
  precision: "float32"
  description: "PirateNet 2D slice on Colab - memory optimized with all fixes"

# =============================================================================
# è³‡æ–™é…ç½®ï¼ˆ2D åˆ‡ç‰‡ï¼‰
# =============================================================================
data:
  type: "jhtdb_channel"
  dataset: "channel"
  re_tau: 1000
  
  data_dir: "./data/jhtdb"
  lowfi_dir: "./data/lowfi"
  
  # JHTDB è³‡æ–™è¼‰å…¥
  jhtdb_config:
    enabled: true
    dataset: "channel"
    re_tau: 1000
    time_step: 0.0
    use_cache: true
    
    # Domain configuration
    domain:
      x: [0.0, 25.132741228718345]  # 8Ï€
      y: [-1.0, 1.0]  # âœ… ä¿®å¾©ï¼šæ­£ç¢ºçš„å£é¢ä½ç½®
      z: [0.0, 9.42477796076938]    # 3Ï€
    
    # Physical parameters
    Re_tau: 1000.0
    nu: 5.0e-5
    u_tau: 0.04997
  
  # Top-level domain (for physics module)
  domain:
    x_min: 0.0
    x_max: 25.132741228718345
    y_min: -1.0  # âœ… ä¿®å¾©ï¼š-1 è€Œé 0
    y_max: 1.0
    z_min: 0.0
    z_max: 9.42477796076938
  
  # ğŸ”§ 2D åˆ‡ç‰‡é…ç½®ï¼ˆé—œéµï¼šé™ä½è¨˜æ†¶é«”ï¼‰
  slice_2d:
    enabled: true
    plane: "xy"  # ä¸»å‰ªåˆ‡å¹³é¢ï¼ˆx-y å¹³é¢ï¼‰
    z_position: 4.71  # z ä¸­å¿ƒä½ç½®ï¼ˆ3Ï€/2ï¼‰
    steady_state: true
    time_average_window: [20.0, 26.0]
  
  # æ„Ÿæ¸¬é»èˆ‡é…é»
  num_sensors: 50
  sensor_type: "qr_pivot"
  sensor_noise: 0.01
  
  num_collocation: 2048  # âœ… é™ä½è‡³ 2048ï¼ˆåŸ 8192ï¼‰
  num_boundary: 256      # âœ… é™ä½è‡³ 256ï¼ˆåŸ 512ï¼‰
  num_initial: 128       # âœ… é™ä½è‡³ 128ï¼ˆåŸ 256ï¼‰

# =============================================================================
# æ„Ÿæ¸¬é»é…ç½®
# =============================================================================
sensors:
  K: 50
  selection_method: "qr_pivot"
  spatial_coverage: "optimal"

# =============================================================================
# æ¨¡å‹æ¶æ§‹ï¼ˆPirateNet æ¨™æº–é…ç½®ï¼‰
# =============================================================================
model:
  type: "enhanced_fourier_mlp"
  
  in_dim: 2   # âœ… 2D åˆ‡ç‰‡ï¼š(x, y)
  out_dim: 4  # (u, v, w, p)
  depth: 6    # PirateNet: 2 residual blocks Ã— 3 layers
  width: 768  # PirateNet æ¨™æº–å¯¬åº¦
  
  activation: "swish"  # PirateNet æ¿€æ´»å‡½æ•¸
  
  # Fourier Featuresï¼ˆPirateNet RFF é…ç½®ï¼‰
  use_fourier: true
  fourier_m: 64      # 64 å€‹éš¨æ©Ÿç‰¹å¾µ
  fourier_sigma: 2.0  # N(0, 2) åˆ†ä½ˆ
  fourier_multiscale: false
  trainable_fourier: false
  
  # RWFï¼ˆPirateNet æ¬Šé‡å› å­åŒ–ï¼‰
  use_rwf: true
  rwf_scale_mean: 1.0  # Î¼ = 1.0
  rwf_scale_std: 0.1   # Ïƒ = 0.1
  
  use_residual: true   # å•Ÿç”¨æ®˜å·®é€£æ¥
  use_layer_norm: true  # å±¤æ­¸ä¸€åŒ–
  dropout: 0.0

# =============================================================================
# è¨“ç·´é…ç½®ï¼ˆColab å„ªåŒ–ï¼‰
# =============================================================================
training:
  epochs: 1000  # ä¸­ç­‰è¨“ç·´è¼ªæ•¸
  batch_size: 2048  # âœ… é™ä½æ‰¹æ¬¡å¤§å°ï¼ˆåŸ 8192ï¼‰
  
  # å„ªåŒ–å™¨ï¼ˆColab å¯èƒ½ä¸æ”¯æŒ SOAPï¼Œä½¿ç”¨ Adamï¼‰
  optimizer:
    type: "adam"
    lr: 1.0e-3  # PirateNet åŸºç¤å­¸ç¿’ç‡
    betas: [0.9, 0.999]
    weight_decay: 0.0
  
  # âœ… ä¿®å¾©ï¼šæ˜ç¢ºå•Ÿç”¨å­¸ç¿’ç‡èª¿åº¦å™¨
  scheduler:
    type: "warmup_exponential"
    warmup_epochs: 20  # å°æ‡‰ ~2000 steps
    decay_rate: 0.9
    decay_epochs: 20   # å°æ‡‰ 2000 decay steps
    min_lr: 1.0e-6
  
  # æ¡æ¨£é…ç½®ï¼ˆé™ä½è¨˜æ†¶é«”ï¼‰
  sampling:
    pde_points: 2048       # âœ… é™ä½ï¼ˆåŸ 8192ï¼‰
    boundary_points: 256   # âœ… é™ä½ï¼ˆåŸ 512ï¼‰
    wall_clustering: 0.3
  
  validation_freq: 50
  checkpoint_freq: 100
  log_interval: 10
  
  gradient_clip: 1.0  # é˜²æ­¢æ¢¯åº¦çˆ†ç‚¸

# =============================================================================
# æå¤±æ¬Šé‡ï¼ˆPirateNet GradNorm é…ç½®ï¼‰
# =============================================================================
losses:
  data_loss_weight: 100.0
  pde_loss_weight: 1.0
  wall_loss_weight: 10.0
  initial_loss_weight: 50.0
  prior_weight: 0.1
  
  # âœ… å•Ÿç”¨è‡ªé©æ‡‰æ¬Šé‡ï¼ˆGradNormï¼‰
  adaptive_weights:
    enabled: true
    method: "gradnorm"
    alpha: 1.5
    update_frequency: 100  # æ¯ 100 steps æ›´æ–°
  
  # âœ… å•Ÿç”¨å› æœæ¬Šé‡
  causal_weights:
    enabled: true
    epsilon: 1.0  # å› æœå®¹å¿åº¦
    tol: 0.1

# =============================================================================
# ç‰©ç†é…ç½®ï¼ˆ2D åˆ‡ç‰‡ï¼‰
# =============================================================================
physics:
  type: "vs_pinn_channel_flow"
  nu: 5.0e-5
  re_tau: 1000
  u_tau: 0.04997
  
  # âœ… ä¿®å¾©ï¼šåŸŸç¯„åœèˆ‡è³‡æ–™ä¸€è‡´
  domain:
    x_min: 0.0
    x_max: 25.132741228718345
    y_min: -1.0  # âœ… é—œéµä¿®å¾©
    y_max: 1.0
    z_min: 0.0
    z_max: 9.42477796076938
  
  # VS-PINN ç¸®æ”¾å› å­ï¼ˆ2Dï¼šåªç”¨ N_x å’Œ N_yï¼‰
  scaling:
    use_scaling: true
    N_x: 2.0
    N_y: 12.0
    N_z: 1.0  # âœ… 2D åˆ‡ç‰‡ï¼šz æ–¹å‘ä¸ç¸®æ”¾

# =============================================================================
# è¼¸å‡ºé…ç½®
# =============================================================================
output:
  checkpoint_dir: "./checkpoints/colab_piratenet_2d_slice"
  results_dir: "./results/colab_piratenet_2d_slice"
  visualization_dir: "./results/colab_piratenet_2d_slice/visualizations"
  save_predictions: true
  save_frequency: 100

# =============================================================================
# æ—¥èªŒé…ç½®
# =============================================================================
logging:
  level: "info"
  log_freq: 10
  tensorboard: true  # Colab æ”¯æŒ TensorBoard
  wandb: false  # å¯é¸ï¼šè¨­ç‚º true ä¸¦é…ç½® API key
  
  metrics:
    - "total_loss"
    - "data_loss"
    - "pde_loss"
    - "wall_loss"
    - "learning_rate"

# =============================================================================
# æ—©åœé…ç½®
# =============================================================================
early_stopping:
  enabled: true
  patience: 200  # è¼ƒå¤§è€å¿ƒï¼ˆ1000 epochs è¨“ç·´ï¼‰
  min_delta: 1.0e-7
  monitor: "total_loss"

# =============================================================================
# å¯é‡ç¾æ€§é…ç½®
# =============================================================================
reproducibility:
  deterministic: true
  benchmark: false

# =============================================================================
# Colab å°ˆç”¨è¨­å®š
# =============================================================================
colab:
  mount_gdrive: true  # æ›è¼‰ Google Drive ä¿å­˜æª¢æŸ¥é»
  gdrive_checkpoint_dir: "/content/drive/MyDrive/pinns-mvp/checkpoints/colab_piratenet_2d_slice"
  auto_save_interval: 100  # æ¯ 100 epochs è‡ªå‹•ä¿å­˜åˆ° GDrive
  
  # è³‡æºç›£æ§
  monitor_gpu: true
  monitor_interval: 50
  
  # ä¸­æ–·æ¢å¾©
  auto_resume: true
  resume_from_gdrive: true

# =============================================================================
# ä½¿ç”¨èªªæ˜
# =============================================================================
usage_notes: |
  ğŸ¯ 2D åˆ‡ç‰‡è¨“ç·´æŒ‡å—ï¼š
  
  âœ… å„ªå‹¢ï¼š
    - è¨˜æ†¶é«”ä½¿ç”¨ ~8 GBï¼ˆvs 3D çš„ ~40 GBï¼‰
    - è¨“ç·´é€Ÿåº¦å¿« 10 å€
    - æ¢¯åº¦è¨ˆç®—ç°¡å–®ï¼ˆ2D vs 3Dï¼‰
    - å¿«é€Ÿé©—è­‰ä¿®å¾©æ˜¯å¦ç”Ÿæ•ˆ
  
  âš™ï¸ é—œéµä¿®å¾©ï¼š
    âœ… å£é¢é‚Šç•Œï¼šy âˆˆ [-1, 1]ï¼ˆä¸‰è™•ä¸€è‡´ï¼‰
    âœ… å­¸ç¿’ç‡èª¿åº¦å™¨ï¼šæ˜ç¢ºå•Ÿç”¨ warmup_exponential
    âœ… GradNormï¼šæ¯ 100 steps æ›´æ–°æ¬Šé‡
    âœ… å› æœæ¬Šé‡ï¼šepsilon=1.0
    âœ… è¨˜æ†¶é«”å„ªåŒ–ï¼šbatch_size=2048, pde_points=2048
  
  ğŸ“Š é æœŸçµæœï¼ˆ1000 epochsï¼‰ï¼š
    - è¨“ç·´æ™‚é–“ï¼š30-60 åˆ†é˜ï¼ˆT4 GPUï¼‰
    - ç›®æ¨™ L2ï¼šâ‰¤ 20%ï¼ˆ2D åˆ‡ç‰‡ï¼‰
    - è¨˜æ†¶é«”å³°å€¼ï¼š~8 GB
    - æª¢æŸ¥é»è‡ªå‹•ä¿å­˜åˆ° Google Drive
  
  ğŸš€ ä½¿ç”¨å‘½ä»¤ï¼š
    # Colab ä¸­åŸ·è¡Œ
    !python scripts/train.py --cfg configs/colab_piratenet_2d_slice.yml
  
  ğŸ“ˆ é©—è­‰ä¿®å¾©æ˜¯å¦ç”Ÿæ•ˆï¼š
    # æª¢æŸ¥è¨“ç·´æ—¥èªŒ
    !tail -50 log/colab_piratenet_2d_slice/training.log
    
    # é—œéµæŒ‡æ¨™ï¼š
    # 1. wall_loss > 0ï¼ˆå£é¢é‚Šç•Œç”Ÿæ•ˆï¼‰
    # 2. learning_rate éæ¸›ï¼ˆèª¿åº¦å™¨ç”Ÿæ•ˆï¼‰
    # 3. total_loss ç©©å®šä¸‹é™ï¼ˆæ”¶æ–‚æ­£å¸¸ï¼‰
  
  âš ï¸ é™åˆ¶ï¼š
    - 2D åˆ‡ç‰‡ç„¡æ³•æ•æ‰ z æ–¹å‘è®ŠåŒ–
    - é©åˆå¿«é€Ÿé©—è­‰ï¼Œä¸é©åˆæœ€çµ‚è©•ä¼°
    - å®Œæ•´è©•ä¼°éœ€ä½¿ç”¨ 3D é…ç½®
  
  ğŸ”„ ä¸‹ä¸€æ­¥ï¼š
    - è‹¥ 2D åˆ‡ç‰‡é”æ¨™ï¼ˆL2 â‰¤ 20%ï¼‰
    - å†å•Ÿç”¨ 3D è¨“ç·´ï¼ˆéœ€æ›´å¤šè¨˜æ†¶é«”ï¼‰
    - æˆ–ä½¿ç”¨æ¢¯åº¦æª¢æŸ¥é»ï¼ˆgradient checkpointingï¼‰

# =============================================================================
# å¿«é€Ÿå•Ÿå‹•å‘½ä»¤ï¼ˆè¤‡è£½åˆ° Colabï¼‰
# =============================================================================
quick_start_commands: |
  # 1. æ›è¼‰ Google Drive
  from google.colab import drive
  drive.mount('/content/drive')
  
  # 2. å…‹éš†å°ˆæ¡ˆ
  !git clone https://github.com/your-repo/pinns-mvp.git
  %cd pinns-mvp
  
  # 3. å®‰è£ä¾è³´
  !pip install -q torch torchvision torchaudio
  !pip install -q pyJHTDB h5py pyyaml tensorboard
  
  # 4. ä¸‹è¼‰æ•¸æ“šï¼ˆ2D åˆ‡ç‰‡ï¼‰
  !mkdir -p data/jhtdb/channel_flow_re1000
  !python scripts/fetch_channel_flow.py --K 50 --slice-2d
  
  # 5. é–‹å§‹è¨“ç·´ï¼ˆ2D åˆ‡ç‰‡ï¼‰
  !python scripts/train.py --cfg configs/colab_piratenet_2d_slice.yml
  
  # 6. ç›£æ§è¨“ç·´ï¼ˆæ–° Cellï¼‰
  %load_ext tensorboard
  %tensorboard --logdir ./checkpoints/colab_piratenet_2d_slice
