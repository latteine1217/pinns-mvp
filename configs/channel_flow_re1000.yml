# Channel Flow Re1000 PINNs 逆重建專用配置檔案
# 基於約翰霍普金斯湍流資料庫 (JHTDB) Channel Flow Re_tau=1000 資料集
# 專用於從稀疏感測點重建完整湍流場的 PINNs 逆問題

# 基本實驗設定
experiment:
  name: "pinnx_channel_flow_re1000"
  version: "v1.0"
  seed: 42
  device: "auto"  # auto會自動選擇最佳設備 (CUDA > MPS > CPU)
  precision: "float32"
  description: "Channel Flow Re1000 稀疏重建實驗"

# 資料相關設定 - JHTDB Channel Flow Re1000 特化
data:
  # 高保真資料來源 - JHTDB Channel Flow
  source: "jhtdb"
  dataset: "channel"  # Re_tau=1000 通道流
  
  # JHTDB Channel Flow Re1000 資料集參數
  jhtdb_config:
    enabled: true                   # 🔧 修復：明確啟用JHTDB載入
    dataset_name: "channel"
    description: "通道流 (Re_tau=1000)"
    # 實際JHTDB域範圍 (基於摩擦速度u_tau標準化)
    domain:
      x: [0, 25.13]      # x ∈ [0, 8π] 流向 (週期性)
      y: [-1.0, 1.0]     # y ∈ [-1, 1] 壁法向 (壁面條件)
      z: [0, 9.42]       # z ∈ [0, 3π] 展向 (週期性)
    resolution:
      x: 2048
      y: 512
      z: 1536
    time_range: [0.0, 26.0]
    dt: 0.0065
    variables: ['u', 'v', 'w', 'p']
  
  # 資料預處理
  normalize: true
  cache_dir: "./data/jhtdb/channel_flow_re1000"
  
  # 噪聲與遺失設定 (模擬真實感測環境)
  noise_sigma: 0.02  # 2% 高斯噪聲
  dropout_prob: 0.10  # 10% 隨機遺失
  
  # 2D切片配置 (從3D場提取2D進行初始驗證)
  slice_config:
    plane: "xy"        # 提取 x-y 平面 (流向-壁法向)
    z_position: 4.71   # z = 3π/2 位置切片
    steady_state: true # 使用時間平均場
    time_average_window: [20.0, 26.0]  # 統計穩態時間窗口

# 感測點配置 - 針對Channel Flow優化
sensors:
  K: 20  # 感測點數量 - 標準化為20個點
  selection_method: "qr_pivot"  # QR-pivot最適感測配置
  spatial_coverage: "wall_biased"  # 偏向壁面區域覆蓋
  
  # Channel Flow 特有感測策略
  wall_enhancement: true     # 強化近壁面感測
  wall_region_ratio: 0.4     # 40% 感測點配置在 y+ < 30 區域
  log_layer_coverage: true   # 確保對數律層覆蓋
  
  # 物理引導的感測點分佈
  physics_guided:
    boundary_layer_focus: true
    shear_stress_regions: true
    turbulence_intensity_regions: true

# 模型架構設定 - Channel Flow Re1000 優化
model:
  type: "fourier_mlp"
  
  # 網路結構 - 針對Channel Flow Re1000調整
  in_dim: 2     # [x, y] 定常2D切片重建
  out_dim: 4    # [u, v, p, S] (流向速度、壁法向速度、壓力、源項)
  width: 256    # 平衡精度與效率
  depth: 6      # 足夠深度捕捉壁面層-對數律層-核心區轉換
  activation: "tanh"
  
  # Fourier Features - Channel Flow 多尺度優化
  fourier_m: 48  # 捕捉Channel Flow多尺度結構
  fourier_sigma: 3.0  # 適應壁面高梯度區域
  
  # VS-PINN 變數尺度化 - Re1000特化
  scaling:
    learnable: true
    input_norm: "channel_flow"  # 專用標準化 (壁面座標)
    output_norm: "friction_velocity"  # 基於摩擦速度標準化
    # Channel Flow特有尺度參數
    friction_velocity: 1.0  # u_tau參考值
    channel_half_height: 1.0  # h參考值
    viscous_length: 1.0e-3  # δ_ν = ν/u_tau

# 物理設定 - Channel Flow Re1000 精確參數
physics:
  # 流體參數 (Re_tau = 1000)
  nu: 1.0e-3       # 動力黏性係數 ν = 1/Re_tau
  rho: 1.0         # 密度 (標準化)
  
  # Channel Flow 特有參數
  channel_flow:
    Re_tau: 1000.0              # 摩擦雷諾數
    Re_bulk: 41980.0            # 體積雷諾數 (近似)
    u_tau: 1.0                  # 摩擦速度 (標準化)
    pressure_gradient: -1.0     # 主流方向壓力梯度
    
  # 計算域 (標準化到物理單位)
  domain:
    x_range: [0.0, 25.13]    # 8π流向長度
    y_range: [-1.0, 1.0]     # 壁面座標
    
  # 邊界條件 - Channel Flow
  boundary_conditions:
    # 壁面條件
    wall_velocity: [0.0, 0.0]   # 無滑移條件
    wall_location: [-1.0, 1.0]  # 上下壁面位置
    
    # 週期性條件
    periodic_x: true             # 流向週期性
    
    # 壓力梯度驱动
    pressure_driven: true
    mean_pressure_gradient: -1.0

# 損失函數權重 - Channel Flow Re1000 調優
losses:
  # 基本損失權重
  data_weight: 10.0     # 強化觀測資料一致性
  boundary_weight: 10.0  # 壁面無滑移條件
  
  # PDE 殘差權重
  momentum_x_weight: 1.0    # 流向動量方程
  momentum_y_weight: 1.0    # 壁法向動量方程
  continuity_weight: 1.0    # 連續方程
  
  # Channel Flow 特有約束
  wall_constraint_weight: 5.0      # 壁面無滑移強化
  periodicity_weight: 2.0          # 週期性邊界約束
  pressure_gradient_weight: 1.0    # 壓力梯度約束
  
  # 物理先驗與正則化
  prior_weight: 0.3         # RANS/LES低保真先驗
  source_l1: 1.0e-6        # 源項稀疏正則化
  gradient_penalty: 1.0e-4  # 壁面梯度懲罰
  
  # 動態權重設定
  adaptive_weighting: true
  weight_update_freq: 1000
  grad_norm_alpha: 0.9
  
  # 時間因果權重 (2D定常場不需要)
  causal_weighting: false

# 訓練設定 - Channel Flow Re1000 穩定化
training:
  # 最佳化器
  optimizer: "adam"
  lr: 8.0e-4              # 針對Channel Flow調整
  weight_decay: 1.0e-5
  lr_scheduler: "cosine"
  
  # 訓練參數
  max_epochs: 15000       # Channel Flow 收斂較快
  batch_size: 1024
  validation_freq: 500
  checkpoint_freq: 2000
  early_stopping: true
  patience: 3000
  
  # 取樣策略 - Channel Flow 優化
  sampling:
    pde_points: 4096     # PDE 殘差計算點數 - 標準化為4096個點
    boundary_points: 1000 # 壁面採樣
    wall_clustering: 0.3  # 30% 點集中在近壁面區域 (y+ < 30)
    
  # 課程學習 - Channel Flow 階段訓練
  curriculum: true
  curriculum_schedule: "exponential"
  curriculum_stages:
    - epochs: 50        # 階段1：壁面邊界條件
      active_losses: ["boundary", "wall_constraint"]
      sampling_focus: "wall"
    - epochs: 150       # 階段2：加入動量方程
      active_losses: ["boundary", "wall_constraint", "momentum"]
      sampling_focus: "boundary_layer"
    - epochs: -1        # 階段3：完整物理約束
      active_losses: ["all"]
      sampling_focus: "full_domain"

# Ensemble 與不確定性量化
ensemble:
  enable: false  # 單模型先驗證，後續可開啟UQ分析
  n_models: 8
  seeds: [0, 1, 2, 3, 4, 5, 6, 7]
  uncertainty_quantification: true
  confidence_level: 0.95

# 評估設定 - Channel Flow 專用指標
evaluation:
  # 評估網格 (符合Channel Flow解析度)
  grid_resolution: [256, 128]  # [x, y] 方向
  
  # Channel Flow 專用評估指標
  metrics:
    - "relative_l2"           # 相對 L2 誤差
    - "wall_shear_stress"     # 壁面剪應力 (關鍵Channel Flow指標)
    - "velocity_profile"      # 速度剖面 (對數律驗證)
    - "friction_coefficient"  # 摩擦係數
    - "turbulence_statistics" # 湍流統計量
    - "pressure_drop"         # 壓降
    - "uncertainty_corr"      # UQ 相關性 (ensemble模式)
    
  # 成功門檻 - Channel Flow Re1000 標準
  thresholds:
    l2_error: 0.10              # ≤ 10% L2 誤差
    wall_shear_error: 0.05      # ≤ 5% 壁面剪應力誤差
    velocity_profile_error: 0.08 # ≤ 8% 速度剖面誤差
    rmse_improvement: 0.30      # ≥ 30% 對低保真改善
    uq_correlation: 0.6         # r ≥ 0.6 UQ相關性
    
  # Channel Flow 特有驗證
  channel_flow_validation:
    log_law_region: [30, 300]   # y+ 對數律區域驗證
    von_karman_constant: 0.41   # 卡門常數驗證
    wake_parameter: 0.55        # 尾流參數驗證

# 日誌與儲存
logging:
  level: "info"
  log_freq: 100
  save_predictions: true
  save_checkpoints: true
  
  # Channel Flow 專用輸出
  save_velocity_profiles: true  # 保存速度剖面
  save_wall_quantities: true    # 保存壁面量
  save_turbulence_fields: true  # 保存湍流場
  
  wandb:
    project: "pinnx-channel-flow-re1000"
    entity: null
    tags: ["pinns", "inverse", "channel_flow", "re1000", "jhtdb"]

# 重現性設定
reproducibility:
  deterministic: true
  benchmark: false
  num_workers: 4

# Channel Flow Re1000 專用驗證設定
validation:
  # 與 DNS 基準比較
  dns_benchmark: true
  dns_data_path: "./data/jhtdb/channel_flow_re1000/dns_reference"
  
  # 湍流統計驗證
  turbulence_statistics:
    reynolds_stress: true      # 雷諾茲應力
    turbulent_kinetic_energy: true  # 湍動能
    dissipation_rate: true     # 耗散率
    
  # 壁面量驗證
  wall_quantities:
    skin_friction: true        # 表面摩擦
    heat_transfer: false       # 熱傳遞 (如需要)
    pressure_fluctuation: true # 壓力脈動

# 效能優化設定
performance:
  # GPU 記憶體優化
  mixed_precision: true      # 混合精度訓練
  gradient_checkpointing: false
  
  # 計算優化
  vectorized_operations: true
  parallel_sampling: true
  
  # 記憶體管理
  max_gpu_memory_fraction: 0.9
  clear_cache_freq: 1000