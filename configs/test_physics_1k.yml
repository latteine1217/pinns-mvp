# ğŸ¯ 1000 Epoch ä¿®æ­£é…ç½® v3 - è‡ªé©æ‡‰æ¬Šé‡ä¿®æ­£ç‰ˆ
# ç›®æ¨™ï¼šä¿®æ­£ v2 çš„æ¬Šé‡ä¸å¹³è¡¡å•é¡Œï¼ˆdata loss ä½” 93%ï¼‰
# å‰µå»ºæ™‚é–“: 2025-10-15
# åŸºç¤ç‰ˆæœ¬: test_physics_fix_1k_v2.yml
# â­ æ ¸å¿ƒä¿®æ­£ï¼šè‡ªé©æ‡‰æ¬Šé‡åƒæ•¸èª¿æ•´ + åˆå§‹ PDE æ¬Šé‡å¤§å¹…æå‡

# åŸºæœ¬å¯¦é©—è¨­å®š
experiment:
  name: "test_physics_fix_1k_v3"
  version: "v3.0_adaptive_fix"
  seed: 42
  device: "auto"
  precision: "float32"
  description: "Fix adaptive weighting failure in v2 (data=93%, PDE=5%)"

# é‡ç¾æ€§è¨­å®š
reproducibility:
  deterministic: true
  benchmark: false
  num_workers: 4

# è³‡æ–™ç›¸é—œè¨­å®š
data:
  source: "jhtdb"
  dataset: "channel"
  
  jhtdb_config:
    enabled: true
    dataset_name: "channel"
    description: "é€šé“æµ (Re_tau=1000)"
    domain:
      x: [0, 25.13]
      y: [-1.0, 1.0]
      z: [0, 9.42]
    resolution:
      x: 2048
      y: 512
      z: 1536
    time_range: [0.0, 26.0]
    dt: 0.0065
    variables: ['u', 'v', 'w', 'p']
  
  normalize: true
  cache_dir: "./data/jhtdb/channel_flow_re1000"

# è³‡æ–™æ¨™æº–åŒ–é…ç½®
normalization:
  type: 'training_data_norm'
  params: {}
  noise_sigma: 0.02
  dropout_prob: 0.10
  
  slice_config:
    plane: "xy"
    z_position: 4.71
    steady_state: true
    time_average_window: [20.0, 26.0]

# æ„Ÿæ¸¬é»é…ç½®
sensors:
  K: 500
  selection_method: "qr_pivot"
  spatial_coverage: "optimal"

# æ¨¡å‹æ¶æ§‹è¨­å®š
model:
  type: "enhanced_fourier_mlp"
  in_dim: 3
  out_dim: 4
  width: 256
  depth: 6
  activation: "sine"
  
  fourier_features:
    type: "axis_selective"
    axes_config: {x: [1, 2], y: [], z: [1, 2]}
    full_axes_config: {x: [1, 2, 4, 8], y: [], z: [1, 2, 4, 8]}
    domain_lengths: {x: 25.13, y: 2.0, z: 9.42}
    fourier_m: 32
    fourier_sigma: 5.0
  
  # VS-PINN ç¸®æ”¾
  scaling:
    learnable: true
    input_norm: "channel_flow"
    output_norm: "friction_velocity"
    friction_velocity: 0.04997
    channel_half_height: 1.0
    viscous_length: 1.0e-3

# â­ ç‰©ç†è¨­å®š
physics:
  type: "vs_pinn_channel_flow"
  nu: 5.0e-5
  rho: 1.0
  
  # VS-PINN ç‰¹å®šé…ç½®
  vs_pinn:
    scaling_factors:
      N_x: 2.0
      N_y: 12.0
      N_z: 2.0
    
    # PDE æå¤±ä¿®æ­£
    loss_config:
      warmup_epochs: 5
    
    # é‚Šç•Œæ¡æ¨£ç­–ç•¥
    boundary_config:
      boundary_band_width: 5.0e-3
    
    enable_rans: false
  
  channel_flow:
    Re_tau: 1000.0
    Re_bulk: 39998.0
    u_tau: 0.04997
    pressure_gradient: 0.0025
    
  domain:
    x_range: [0.0, 25.13]
    y_range: [-1.0, 1.0]
    z_range: [0.0, 9.42]
    
  boundary_conditions:
    wall_velocity: [0.0, 0.0, 0.0]
    wall_location: [-1.0, 1.0]
    periodic_x: true
    periodic_z: true
    pressure_driven: true
    mean_pressure_gradient: 0.0025

# â­â­â­ ä¿®æ­£æå¤±å‡½æ•¸æ¬Šé‡ï¼ˆæ ¸å¿ƒä¿®æ”¹ï¼‰
losses:
  # â­ ä¿®æ”¹ 1: é™ä½ data æ¬Šé‡ä»¥å¹³è¡¡
  data_weight: 5.0              # v2: 10.0 â†’ v3: 5.0 (é™ä½ 50%)
  boundary_weight: 5.0          # v2: 10.0 â†’ v3: 5.0 (ä¿æŒä¸€è‡´)
  
  # â­ ä¿®æ”¹ 2: é¡¯è‘—æå‡ PDE åŸºç¤æ¬Šé‡
  momentum_x_weight: 2.0        # v2: 1.0 â†’ v3: 2.0 (æå‡ 2Ã—)
  momentum_y_weight: 2.0        # v2: 1.0 â†’ v3: 2.0
  momentum_z_weight: 2.0        # v2: 1.0 â†’ v3: 2.0
  continuity_weight: 2.0        # v2: 1.0 â†’ v3: 2.0
  
  wall_constraint_weight: 8.0   # v2: 5.0 â†’ v3: 8.0 (æå‡ 60%)
  periodicity_weight: 2.0
  pressure_gradient_weight: 1.0
  
  prior_weight: 0.3
  source_l1: 1.0e-6
  gradient_penalty: 1.0e-4
  
  # â­â­ ä¿®æ”¹ 3: è‡ªé©æ‡‰æ¬Šé‡åƒæ•¸ä¿®æ­£ï¼ˆæ ¸å¿ƒï¼‰
  adaptive_weighting: true
  weight_update_freq: 50        # v2: 100 â†’ v3: 50 (æ›´é »ç¹èª¿æ•´)
  grad_norm_alpha: 1.5          # v2: 0.12 â†’ v3: 1.5 (æ¨™æº–å€¼ï¼Œæå‡ 12.5Ã—)
  
  adaptive_loss_terms:
    - data
    - momentum_x
    - momentum_y
    - momentum_z
    - continuity
    - wall_constraint
    - periodicity
  
  causal_weighting: false

# â­ èª²ç¨‹è¨“ç·´è¨­å®šï¼ˆ1000 epochsï¼Œ2 éšæ®µï¼‰
training:
  optimizer: "adam"
  lr: 1.0e-3
  weight_decay: 1.0e-5
  
  lr_scheduler:
    type: "cosine_annealing_warmup"
    min_lr: 1.0e-6
    warmup_epochs: 50
    T_max: 1000
  
  epochs: 1000
  max_epochs: 1000
  batch_size: 1024
  validation_freq: 50
  checkpoint_freq: 100
  log_interval: 20
  
  early_stopping:
    enabled: true
    patience: 200
    min_delta: 1.0e-7
  
  # â­ ä¿®æ”¹ 4: å¢åŠ å£é¢é»æ¡æ¨£
  sampling:
    pde_points: 2048
    boundary_points: 1000       # v2: 500 â†’ v3: 1000 (æå‡ 2Ã—)
    wall_clustering: 0.3
  
  gradient_clip: 1.0

# â­ èª²ç¨‹å­¸ç¿’é…ç½®ï¼ˆ2 éšæ®µï¼Œæ¿€é€² PDE æ¬Šé‡ï¼‰
curriculum:
  enable: true
  stages:
    # éšæ®µ 1: å¼· PDE æš–å•Ÿï¼ˆEpochs 0-300ï¼‰
    - name: "Stage1_StrongPDE"
      epoch_range: [0, 300]
      Re_tau: 1000.0
      nu: 5.0e-5
      pressure_gradient: 0.0025
      lr: 1.0e-3
      
      weights:
        data: 5.0                # v2: 15.0 â†’ v3: 5.0
        boundary: 5.0            # v2: 12.0 â†’ v3: 5.0
        momentum_x: 5.0          # v2: 1.5 â†’ v3: 5.0 (â­ æå‡ 3.3Ã—)
        momentum_y: 5.0          # v2: 1.5 â†’ v3: 5.0
        momentum_z: 5.0          # v2: 1.5 â†’ v3: 5.0
        continuity: 5.0          # v2: 1.5 â†’ v3: 5.0
        wall_constraint: 10.0    # v2: 10.0 â†’ v3: 10.0 (ä¿æŒ)
        periodicity: 2.0
        pressure_gradient: 1.0
      
      sampling:
        pde_points: 2048
        boundary_points: 1000    # v2: 500 â†’ v3: 1000
        wall_clustering: 0.3
    
    # éšæ®µ 2: PDE ä¸»å°ï¼ˆEpochs 300-1000ï¼‰
    - name: "Stage2_PDEDominance"
      epoch_range: [300, 1000]
      Re_tau: 1000.0
      nu: 5.0e-5
      pressure_gradient: 0.0025
      lr: 3.0e-4
      
      weights:
        data: 5.0                # v2: 10.0 â†’ v3: 5.0
        boundary: 5.0            # v2: 10.0 â†’ v3: 5.0
        momentum_x: 8.0          # v2: 3.0 â†’ v3: 8.0 (â­ æå‡ 2.7Ã—)
        momentum_y: 8.0          # v2: 3.0 â†’ v3: 8.0
        momentum_z: 8.0          # v2: 3.0 â†’ v3: 8.0
        continuity: 8.0          # v2: 3.0 â†’ v3: 8.0
        wall_constraint: 10.0    # v2: 5.0 â†’ v3: 10.0 (æå‡ 2Ã—)
        periodicity: 2.0
        pressure_gradient: 1.0
      
      sampling:
        pde_points: 2048
        boundary_points: 1000
        wall_clustering: 0.3

# Ensemble è¨­å®šï¼ˆé—œé–‰ï¼‰
ensemble:
  enable: false

# è©•ä¼°è¨­å®š
evaluation:
  grid_resolution: [128, 64, 64]
  
  metrics:
    - "relative_l2"
    - "wall_shear_stress"
    - "mass_conservation"
    - "mean_velocity_profile"
    - "turbulent_kinetic_energy"
    - "reynolds_stress"
    - "energy_spectrum"
    
  thresholds:
    l2_error: 0.30
    mass_conservation_error: 1.0e-3      # v2: 1e-4 â†’ v3: 1e-3 (æ”¾å¯¬)
    wall_shear_stress_error: 0.30
    mean_profile_correlation: 0.85

# æ—¥èªŒèˆ‡å„²å­˜
logging:
  level: "info"
  log_freq: 20
  save_predictions: true
  tensorboard: true
  wandb: false
  
  stage_diagnostics: true
  save_loss_history: true
  save_weight_evolution: true

output:
  checkpoint_dir: "./checkpoints/test_physics_fix_1k_v3"
  results_dir: "./results/test_physics_fix_1k_v3"
  visualization_dir: "./results/test_physics_fix_1k_v3/visualizations"
  
  save_stage_checkpoints: true

# ğŸ¯ æ¸¬è©¦é©—æ”¶æ¨™æº–
test_acceptance:
  stability:
    - no_nan_inf: true
    - loss_finite: true
    - gradient_stable: true
    - no_mode_collapse: true
  
  performance:
    # â­ æœŸæœ›æ¬Šé‡å¹³è¡¡ï¼šPDE >= 30% (v2 åƒ… 5%)
    - pde_loss_ratio_target: 0.30        # PDE/(PDE+Data) >= 30%
    - u_l2_error_target: 0.30
    - v_l2_error_target: 0.50
    - w_l2_error_target: 0.50
    - p_l2_error_target: 0.50
    
    # â­ ç‰©ç†ä¸€è‡´æ€§ï¼ˆv2 å®Œå…¨å¤±æ•ˆï¼‰
    - mass_conservation_error_target: 1.0e-2
    - momentum_residual_target: 1.0e-2
    - wall_shear_stress_error_target: 0.50
    - tau_w_ratio_target: 5.0            # |Ï„_w| / Ï„_w(theory) >= 5.0
    
    # å‹•æ…‹ç¯„åœ
    - dynamic_range_coverage_u: 0.80
    - dynamic_range_coverage_p: 0.70
  
  convergence:
    - loss_converged: true
    - validation_stable: true
    - no_overfitting: true
    - curriculum_completed: true

# é…ç½®è®Šæ›´è¨˜éŒ„
change_log:
  - date: "2025-10-15"
    version: "v3.0_adaptive_fix"
    changes:
      - "â­ è‡ªé©æ‡‰æ¬Šé‡ä¿®æ­£ï¼šalpha=0.12â†’1.5, freq=100â†’50"
      - "â­ é™ä½ data æ¬Šé‡ï¼š10.0â†’5.0 (Stage1/2)"
      - "â­ æå‡ PDE æ¬Šé‡ï¼šStage1=1.5â†’5.0, Stage2=3.0â†’8.0"
      - "â­ å£é¢ç´„æŸå¼·åŒ–ï¼šStage2=5.0â†’10.0"
      - "â­ å£é¢é»æ¡æ¨£åŠ å€ï¼š500â†’1000"
      - "ç›®æ¨™ï¼šä¿®æ­£ v2 çš„æ¬Šé‡å¤±è¡¡ï¼ˆdata=93%, PDE=5%ï¼‰"

# å¯¦é©—å‡è¨­ï¼ˆv3 ä¿®æ­£ç‰ˆï¼‰
experiment_hypothesis:
  motivation: |
    âš ï¸ v2 å•é¡Œè¨ºæ–·ï¼š
    - è‡ªé©æ‡‰æ¬Šé‡å¤±æ•ˆï¼ˆalpha=0.12 å¤ªå°ï¼Œfreq=100 å¤ªé•·ï¼‰
    - å°è‡´ data loss ä½” 93%ï¼ŒPDE åƒ… 5%
    - ç‰©ç†å®Œå…¨å¤±æ•ˆï¼šÏ„_wâ‰ˆ0, âˆ‡Â·u>50, wall violation>16
    
    ğŸ¯ v3 ä¿®æ­£ç­–ç•¥ï¼š
    1. è‡ªé©æ‡‰åƒæ•¸æ¨™æº–åŒ–ï¼ˆalpha=1.5, freq=50ï¼‰
    2. åˆå§‹æ¬Šé‡å¹³è¡¡ï¼ˆdata=5, PDE=5-8ï¼‰
    3. å£é¢æ¡æ¨£åŠ å€ï¼ˆ500â†’1000ï¼‰
  
  v2_failure_analysis:
    epoch_979_weights:
      - "weighted_data_loss: 0.542 (93.1%)"
      - "weighted_pde_loss: 0.029 (5.0%)"
      - "weighted_wall_loss: 0.038 (6.5%)"
    physics_failures:
      - "Ï„_w ratio: 0.000 (ç†è«– 0.0025, å¯¦éš› ~0)"
      - "max âˆ‡Â·u: 51.07 (ç›®æ¨™ <0.001)"
      - "wall u violation: 16.5 (ç›®æ¨™ 0)"
      - "wall w violation: 22.2 (ç›®æ¨™ 0)"
  
  expected_outcome:
    # å¿«é€Ÿæ¸¬è©¦ï¼ˆ100 epochsï¼‰
    - "Epoch 50: PDE ratio >= 20%ï¼ˆv2 ç‚º 5%ï¼‰"
    - "Epoch 100: Ï„_w > 0.0005ï¼ˆéé›¶è­‰æ“šï¼‰"
    
    # å®Œæ•´è¨“ç·´ï¼ˆ1000 epochsï¼‰
    - "Epoch 300: PDE ratio >= 30%, Ï„_w > 0.001"
    - "Epoch 600: wall violation < 1.0, âˆ‡Â·u < 0.1"
    - "Epoch 1000: Ï„_w > 0.0005 (ç†è«– 20%), L2 < 30%"
  
  success_criteria:
    minimal: "PDE ratio >= 30% ä¸” Ï„_w éé›¶"
    target: "Ï„_w ratio >= 5.0 ä¸” L2 < 30%"
    stretch: "Ï„_w ratio >= 10.0 ä¸” wall violation < 0.1"

# éšæ®µæ€§è©•ä¼°è¨ˆç•«ï¼ˆå¿«é€Ÿæ¸¬è©¦å„ªå…ˆï¼‰
evaluation_milestones:
  - epoch: 20
    expected_pde_ratio: 0.15
    expected_tau_w_ratio: 0.1
    action: "âš ï¸ è‹¥ PDE ratio < 10%ï¼Œç«‹å³ä¸­æ­¢ä¸¦èª¿æ•´ alpha"
  
  - epoch: 50
    expected_pde_ratio: 0.25
    expected_tau_w_ratio: 0.5
    action: "è‹¥ PDE ratio >= 20%ï¼Œç¹¼çºŒè‡³ 100ï¼›å¦å‰‡ä¸­æ­¢"
  
  - epoch: 100
    expected_pde_ratio: 0.30
    expected_tau_w_ratio: 1.0
    action: "â­ å¿«é€Ÿæ¸¬è©¦é©—æ”¶é»ï¼šæ±ºå®šæ˜¯å¦é€²å…¥ 1000 epochs"
  
  - epoch: 300
    expected_pde_ratio: 0.35
    expected_tau_w_ratio: 5.0
    action: "Stage1 å®Œæˆï¼Œæª¢æŸ¥ç‰©ç†ç´„æŸæ”¹å–„"
  
  - epoch: 1000
    expected_pde_ratio: 0.40
    expected_tau_w_ratio: 10.0
    action: "â­ æœ€çµ‚é©—æ”¶ï¼šæ±ºå®šæ˜¯å¦é€²å…¥ç”Ÿç”¢ç´šè¨“ç·´"
