# Design: Physics Checkpoint Validation

## Context
當前專案強調 Physics Gate 原則，但缺乏自動化機制確保保存的檢查點符合物理約束。手動驗證容易遺漏，且無法在訓練過程中即時發現物理違規。

**利害關係人**:
- 研究人員：需要確保實驗結果的物理有效性
- 開發者：需要清晰的驗證 API 與配置選項
- 使用者：需要可靠的檢查點用於後續評估

**約束**:
- 驗證時間必須 <5 秒（避免顯著延長訓練時間）
- 必須向後相容（現有配置不應破壞）
- 必須可配置（允許調整閾值或禁用）

## Goals / Non-Goals

### Goals
- ✅ 自動驗證檢查點的物理一致性（質量守恆、動量守恆、邊界條件）
- ✅ 在檢查點元數據中記錄物理指標
- ✅ 提供可配置的驗證閾值
- ✅ 驗證失敗時拒絕保存並記錄警告

### Non-Goals
- ❌ 驗證能量守恆（當前階段不實作，未來可擴展）
- ❌ 驗證湍流統計量（屬於評估階段，非檢查點驗證）
- ❌ 自動修正物理違規（僅檢測，不修正）

## Decisions

### Decision 1: 驗證時機
**選擇**: 在 `Trainer.save_checkpoint()` 調用前執行驗證

**理由**:
- 最小侵入性：僅修改檢查點保存邏輯
- 清晰的失敗點：驗證失敗時立即拒絕保存
- 易於測試：可獨立測試驗證邏輯

**替代方案**:
- ❌ 在每個 epoch 結束後驗證：過於頻繁，增加訓練時間
- ❌ 在評估階段驗證：太晚，已保存無效檢查點

### Decision 2: 驗證指標
**選擇**: 驗證三項核心物理約束
1. **質量守恆**: `max(|∇·u|) < threshold` (預設 1e-2)
2. **動量守恆**: `mean(|NS_residual|) < threshold` (預設 1e-1)
3. **邊界條件**: `max(|u_wall|) < threshold` (預設 1e-3)

**理由**:
- 涵蓋最關鍵的物理約束
- 計算成本低（<5 秒）
- 閾值可配置，適應不同精度需求

**替代方案**:
- ❌ 僅驗證質量守恆：不足以保證物理有效性
- ❌ 驗證所有物理量（含能量、渦度）：計算成本過高

### Decision 3: 失敗處理策略
**選擇**: 驗證失敗時**拒絕保存**並記錄警告日誌

**理由**:
- 強制執行 Physics Gate 原則
- 避免保存無效檢查點污染實驗結果
- 日誌提供除錯資訊

**替代方案**:
- ❌ 僅警告但仍保存：違反 Physics Gate 原則
- ❌ 自動回滾到上一個有效檢查點：過於複雜，可能導致訓練中斷

### Decision 4: 配置設計
**選擇**: 新增 `physics_validation` 配置區塊

```yaml
physics_validation:
  enabled: true  # 預設啟用
  thresholds:
    mass_conservation: 1.0e-2
    momentum_conservation: 1.0e-1
    boundary_condition: 1.0e-3
  save_metrics: true  # 在檢查點元數據中記錄指標
```

**理由**:
- 清晰的配置結構
- 易於調整閾值（不同案例可能需要不同精度）
- 可禁用（用於除錯或特殊情境）

## Risks / Trade-offs

### Risk 1: 驗證時間增加訓練成本
**影響**: 每次保存檢查點增加 2-5 秒
**緩解**: 
- 僅在保存檢查點時驗證（非每個 epoch）
- 使用高效的向量化計算（避免迴圈）
- 提供配置選項允許禁用

### Risk 2: 閾值設定不當導致誤報
**影響**: 過嚴閾值可能拒絕有效檢查點
**緩解**:
- 提供合理的預設值（基於實驗經驗）
- 允許用戶調整閾值
- 在日誌中顯示實際誤差值（方便調整）

### Risk 3: 向後相容性問題
**影響**: 現有配置缺少 `physics_validation` 區塊
**緩解**:
- 預設啟用驗證（安全預設）
- 配置載入器提供預設值
- 更新所有模板配置

## Migration Plan

### Phase 1: 實作核心邏輯（1-2 天）
1. 創建 `pinnx/physics/validators.py`
2. 實作三項驗證函數
3. 撰寫單元測試

### Phase 2: 整合檢查點系統（1 天）
1. 修改 `Trainer.save_checkpoint()`
2. 新增 `validate_physics_before_save()`
3. 撰寫整合測試

### Phase 3: 配置與文檔（1 天）
1. 更新配置 schema
2. 更新模板配置檔案
3. 更新技術文檔

### Rollback Strategy
若驗證邏輯導致訓練中斷：
1. 在配置中設定 `physics_validation.enabled: false`
2. 回滾到上一個穩定版本
3. 修正驗證邏輯後重新部署

## Open Questions
1. **Q**: 是否需要驗證壓力場的物理合理性（如壓力梯度）？
   **A**: 當前階段不實作，未來可擴展

2. **Q**: 驗證失敗時是否應自動降低學習率重試？
   **A**: 不實作自動重試，由使用者手動調整訓練策略

3. **Q**: 是否需要在 TensorBoard 中視覺化物理指標？
   **A**: 可作為未來改進，當前僅記錄至檢查點元數據
